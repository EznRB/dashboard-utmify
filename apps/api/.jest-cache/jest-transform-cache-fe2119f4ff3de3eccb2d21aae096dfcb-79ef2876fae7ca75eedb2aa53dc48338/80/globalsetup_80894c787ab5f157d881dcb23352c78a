1e6a9f7835a4fd03d7e511ac47a12567
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.testEnvironmentConfig = void 0;
exports.default = globalSetup;
exports.checkDatabaseHealth = checkDatabaseHealth;
exports.checkRedisHealth = checkRedisHealth;
exports.seedTestData = seedTestData;
exports.cleanupTestData = cleanupTestData;
const child_process_1 = require("child_process");
const redis_1 = require("redis");
const pg_1 = require("pg");
async function globalSetup() {
    console.log('üöÄ Setting up test environment...');
    try {
        // Set test environment variables
        process.env.NODE_ENV = 'test';
        process.env.DATABASE_URL = process.env.TEST_DATABASE_URL || 'postgresql://test:test@localhost:5432/utmify_test';
        process.env.REDIS_URL = process.env.TEST_REDIS_URL || 'redis://localhost:6379/1';
        process.env.JWT_SECRET = 'test-jwt-secret-for-testing-only';
        process.env.LOG_LEVEL = 'error';
        // Setup test database
        await setupTestDatabase();
        // Setup test Redis
        await setupTestRedis();
        // Run database migrations
        await runDatabaseMigrations();
        // Install stored procedures
        await installStoredProcedures();
        console.log('‚úÖ Test environment setup complete');
    }
    catch (error) {
        console.error('‚ùå Failed to setup test environment:', error);
        process.exit(1);
    }
}
async function setupTestDatabase() {
    console.log('üìä Setting up test database...');
    const databaseUrl = process.env.DATABASE_URL;
    if (!databaseUrl) {
        throw new Error('TEST_DATABASE_URL is not set');
    }
    try {
        // Parse database URL
        const url = new URL(databaseUrl);
        const dbName = url.pathname.slice(1);
        // Connect to PostgreSQL (without specific database)
        const adminClient = new pg_1.Client({
            host: url.hostname,
            port: parseInt(url.port) || 5432,
            user: url.username,
            password: url.password,
            database: 'postgres', // Connect to default database
        });
        await adminClient.connect();
        // Drop test database if exists
        try {
            await adminClient.query(`DROP DATABASE IF EXISTS "${dbName}"`);
        }
        catch (error) {
            // Ignore error if database doesn't exist
        }
        // Create test database
        await adminClient.query(`CREATE DATABASE "${dbName}"`);
        await adminClient.end();
        console.log('‚úÖ Test database created successfully');
    }
    catch (error) {
        console.warn('‚ö†Ô∏è Could not setup test database (may already exist):', error.message);
    }
}
async function setupTestRedis() {
    console.log('üî¥ Setting up test Redis...');
    const redisUrl = process.env.REDIS_URL;
    if (!redisUrl) {
        throw new Error('TEST_REDIS_URL is not set');
    }
    try {
        const client = (0, redis_1.createClient)({ url: redisUrl });
        await client.connect();
        // Clear test Redis database
        await client.flushDb();
        await client.disconnect();
        console.log('‚úÖ Test Redis setup complete');
    }
    catch (error) {
        console.warn('‚ö†Ô∏è Could not setup test Redis:', error.message);
    }
}
async function runDatabaseMigrations() {
    console.log('üîÑ Running database migrations...');
    try {
        // Run Prisma migrations
        (0, child_process_1.execSync)('npx prisma migrate deploy', {
            stdio: 'inherit',
            env: {
                ...process.env,
                DATABASE_URL: process.env.DATABASE_URL,
            },
        });
        // Generate Prisma client
        (0, child_process_1.execSync)('npx prisma generate', {
            stdio: 'inherit',
        });
        console.log('‚úÖ Database migrations completed');
    }
    catch (error) {
        console.warn('‚ö†Ô∏è Could not run migrations:', error.message);
    }
}
async function installStoredProcedures() {
    console.log('üîß Installing stored procedures...');
    try {
        const client = new pg_1.Client({ connectionString: process.env.DATABASE_URL });
        await client.connect();
        // Read and execute stored procedures SQL
        const fs = require('fs');
        const path = require('path');
        const sqlPath = path.join(__dirname, '../../prisma/migrations/001_create_metrics_procedures.sql');
        if (fs.existsSync(sqlPath)) {
            const sql = fs.readFileSync(sqlPath, 'utf8');
            await client.query(sql);
            console.log('‚úÖ Stored procedures installed');
        }
        else {
            console.warn('‚ö†Ô∏è Stored procedures SQL file not found');
        }
        await client.end();
    }
    catch (error) {
        console.warn('‚ö†Ô∏è Could not install stored procedures:', error.message);
    }
}
// Health check functions
async function checkDatabaseHealth() {
    try {
        const client = new pg_1.Client({ connectionString: process.env.DATABASE_URL });
        await client.connect();
        await client.query('SELECT 1');
        await client.end();
        return true;
    }
    catch (error) {
        return false;
    }
}
async function checkRedisHealth() {
    try {
        const client = (0, redis_1.createClient)({ url: process.env.REDIS_URL });
        await client.connect();
        await client.ping();
        await client.disconnect();
        return true;
    }
    catch (error) {
        return false;
    }
}
// Utility functions for tests
async function seedTestData() {
    console.log('üå± Seeding test data...');
    try {
        const { PrismaClient } = require('@prisma/client');
        const prisma = new PrismaClient();
        // Create test organization
        const organization = await prisma.organization.upsert({
            where: { id: '123e4567-e89b-12d3-a456-426614174001' },
            update: {},
            create: {
                id: '123e4567-e89b-12d3-a456-426614174001',
                name: 'Test Organization',
                slug: 'test-org',
                createdAt: new Date(),
                updatedAt: new Date(),
            },
        });
        // Create test user
        const user = await prisma.user.upsert({
            where: { id: '123e4567-e89b-12d3-a456-426614174000' },
            update: {},
            create: {
                id: '123e4567-e89b-12d3-a456-426614174000',
                email: 'test@example.com',
                name: 'Test User',
                organizationId: organization.id,
                createdAt: new Date(),
                updatedAt: new Date(),
            },
        });
        // Create test campaign
        const campaign = await prisma.campaign.upsert({
            where: { id: '123e4567-e89b-12d3-a456-426614174002' },
            update: {},
            create: {
                id: '123e4567-e89b-12d3-a456-426614174002',
                name: 'Test Campaign',
                organizationId: organization.id,
                status: 'ACTIVE',
                createdAt: new Date(),
                updatedAt: new Date(),
            },
        });
        // Create test metrics data
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        await prisma.metricsDaily.upsert({
            where: {
                campaignId_date: {
                    campaignId: campaign.id,
                    date: today,
                },
            },
            update: {},
            create: {
                campaignId: campaign.id,
                date: today,
                impressions: 10000,
                clicks: 500,
                conversions: 50,
                revenue: 5000,
                adSpend: 2000,
                createdAt: new Date(),
                updatedAt: new Date(),
            },
        });
        await prisma.$disconnect();
        console.log('‚úÖ Test data seeded successfully');
    }
    catch (error) {
        console.warn('‚ö†Ô∏è Could not seed test data:', error.message);
    }
}
async function cleanupTestData() {
    console.log('üßπ Cleaning up test data...');
    try {
        const { PrismaClient } = require('@prisma/client');
        const prisma = new PrismaClient();
        // Delete in reverse order of dependencies
        await prisma.metricsDaily.deleteMany({});
        await prisma.metricsHourly.deleteMany({});
        await prisma.conversionEvent.deleteMany({});
        await prisma.funnelStage.deleteMany({});
        await prisma.campaign.deleteMany({});
        await prisma.user.deleteMany({});
        await prisma.organization.deleteMany({});
        await prisma.$disconnect();
        console.log('‚úÖ Test data cleaned up');
    }
    catch (error) {
        console.warn('‚ö†Ô∏è Could not cleanup test data:', error.message);
    }
}
// Export configuration
exports.testEnvironmentConfig = {
    database: {
        url: process.env.DATABASE_URL,
        maxConnections: 10,
        timeout: 30000,
    },
    redis: {
        url: process.env.REDIS_URL,
        maxRetries: 3,
        timeout: 5000,
    },
    api: {
        port: process.env.TEST_PORT || 3001,
        timeout: 30000,
    },
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxFbnpvIE1hcmNlbG9cXERlc2t0b3BcXFByb2pldG9zIEVtcHJlc2FcXFNhYXMgVXRtaWZ5XFx1dG1pZnktY2xvbmVcXGFwcHNcXGFwaVxcc3JjXFx0ZXN0c1xcZ2xvYmFsLXNldHVwLnRzIiwibWFwcGluZ3MiOiI7OztBQUlBLDhCQTRCQztBQXVIRCxrREFVQztBQUVELDRDQVVDO0FBR0Qsb0NBK0VDO0FBRUQsMENBc0JDO0FBdlJELGlEQUF5QztBQUN6QyxpQ0FBcUM7QUFDckMsMkJBQTRCO0FBRWIsS0FBSyxVQUFVLFdBQVc7SUFDdkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDO0lBRWpELElBQUksQ0FBQztRQUNILGlDQUFpQztRQUNqQyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUM7UUFDOUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSxtREFBbUQsQ0FBQztRQUNoSCxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSwwQkFBMEIsQ0FBQztRQUNqRixPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsR0FBRyxrQ0FBa0MsQ0FBQztRQUM1RCxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUM7UUFFaEMsc0JBQXNCO1FBQ3RCLE1BQU0saUJBQWlCLEVBQUUsQ0FBQztRQUUxQixtQkFBbUI7UUFDbkIsTUFBTSxjQUFjLEVBQUUsQ0FBQztRQUV2QiwwQkFBMEI7UUFDMUIsTUFBTSxxQkFBcUIsRUFBRSxDQUFDO1FBRTlCLDRCQUE0QjtRQUM1QixNQUFNLHVCQUF1QixFQUFFLENBQUM7UUFFaEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxxQ0FB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QUksQ0FBQyxpQ0FBaUMsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDakUsQ0FBQztBQUNILENBQUM7QUFFRCx1QkFBdUI7QUFDVixRQUFBLHFCQUFxQixHQUFHO0lBQ25DLFFBQVEsRUFBRTtRQUNSLEdBQUcsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVk7UUFDN0IsY0FBYyxFQUFFLEVBQUU7UUFDbEIsT0FBTyxFQUFFLEtBQUs7S0FDZjtJQUNELEtBQUssRUFBRTtRQUNMLEdBQUcsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVM7UUFDMUIsVUFBVSxFQUFFLENBQUM7UUFDYixPQUFPLEVBQUUsSUFBSTtLQUNkO0lBQ0QsR0FBRyxFQUFFO1FBQ0gsSUFBSSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxJQUFJLElBQUk7UUFDbkMsT0FBTyxFQUFFLEtBQUs7S0FDZjtDQUNGLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxFbnpvIE1hcmNlbG9cXERlc2t0b3BcXFByb2pldG9zIEVtcHJlc2FcXFNhYXMgVXRtaWZ5XFx1dG1pZnktY2xvbmVcXGFwcHNcXGFwaVxcc3JjXFx0ZXN0c1xcZ2xvYmFsLXNldHVwLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGV4ZWNTeW5jIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgeyBjcmVhdGVDbGllbnQgfSBmcm9tICdyZWRpcyc7XG5pbXBvcnQgeyBDbGllbnQgfSBmcm9tICdwZyc7XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIGZ1bmN0aW9uIGdsb2JhbFNldHVwKCkge1xuICBjb25zb2xlLmxvZygn8J+agCBTZXR0aW5nIHVwIHRlc3QgZW52aXJvbm1lbnQuLi4nKTtcbiAgXG4gIHRyeSB7XG4gICAgLy8gU2V0IHRlc3QgZW52aXJvbm1lbnQgdmFyaWFibGVzXG4gICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPSAndGVzdCc7XG4gICAgcHJvY2Vzcy5lbnYuREFUQUJBU0VfVVJMID0gcHJvY2Vzcy5lbnYuVEVTVF9EQVRBQkFTRV9VUkwgfHwgJ3Bvc3RncmVzcWw6Ly90ZXN0OnRlc3RAbG9jYWxob3N0OjU0MzIvdXRtaWZ5X3Rlc3QnO1xuICAgIHByb2Nlc3MuZW52LlJFRElTX1VSTCA9IHByb2Nlc3MuZW52LlRFU1RfUkVESVNfVVJMIHx8ICdyZWRpczovL2xvY2FsaG9zdDo2Mzc5LzEnO1xuICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSAndGVzdC1qd3Qtc2VjcmV0LWZvci10ZXN0aW5nLW9ubHknO1xuICAgIHByb2Nlc3MuZW52LkxPR19MRVZFTCA9ICdlcnJvcic7XG4gICAgXG4gICAgLy8gU2V0dXAgdGVzdCBkYXRhYmFzZVxuICAgIGF3YWl0IHNldHVwVGVzdERhdGFiYXNlKCk7XG4gICAgXG4gICAgLy8gU2V0dXAgdGVzdCBSZWRpc1xuICAgIGF3YWl0IHNldHVwVGVzdFJlZGlzKCk7XG4gICAgXG4gICAgLy8gUnVuIGRhdGFiYXNlIG1pZ3JhdGlvbnNcbiAgICBhd2FpdCBydW5EYXRhYmFzZU1pZ3JhdGlvbnMoKTtcbiAgICBcbiAgICAvLyBJbnN0YWxsIHN0b3JlZCBwcm9jZWR1cmVzXG4gICAgYXdhaXQgaW5zdGFsbFN0b3JlZFByb2NlZHVyZXMoKTtcbiAgICBcbiAgICBjb25zb2xlLmxvZygn4pyFIFRlc3QgZW52aXJvbm1lbnQgc2V0dXAgY29tcGxldGUnKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCfinYwgRmFpbGVkIHRvIHNldHVwIHRlc3QgZW52aXJvbm1lbnQ6JywgZXJyb3IpO1xuICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBzZXR1cFRlc3REYXRhYmFzZSgpIHtcbiAgY29uc29sZS5sb2coJ/Cfk4ogU2V0dGluZyB1cCB0ZXN0IGRhdGFiYXNlLi4uJyk7XG4gIFxuICBjb25zdCBkYXRhYmFzZVVybCA9IHByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTDtcbiAgaWYgKCFkYXRhYmFzZVVybCkge1xuICAgIHRocm93IG5ldyBFcnJvcignVEVTVF9EQVRBQkFTRV9VUkwgaXMgbm90IHNldCcpO1xuICB9XG4gIFxuICB0cnkge1xuICAgIC8vIFBhcnNlIGRhdGFiYXNlIFVSTFxuICAgIGNvbnN0IHVybCA9IG5ldyBVUkwoZGF0YWJhc2VVcmwpO1xuICAgIGNvbnN0IGRiTmFtZSA9IHVybC5wYXRobmFtZS5zbGljZSgxKTtcbiAgICBcbiAgICAvLyBDb25uZWN0IHRvIFBvc3RncmVTUUwgKHdpdGhvdXQgc3BlY2lmaWMgZGF0YWJhc2UpXG4gICAgY29uc3QgYWRtaW5DbGllbnQgPSBuZXcgQ2xpZW50KHtcbiAgICAgIGhvc3Q6IHVybC5ob3N0bmFtZSxcbiAgICAgIHBvcnQ6IHBhcnNlSW50KHVybC5wb3J0KSB8fCA1NDMyLFxuICAgICAgdXNlcjogdXJsLnVzZXJuYW1lLFxuICAgICAgcGFzc3dvcmQ6IHVybC5wYXNzd29yZCxcbiAgICAgIGRhdGFiYXNlOiAncG9zdGdyZXMnLCAvLyBDb25uZWN0IHRvIGRlZmF1bHQgZGF0YWJhc2VcbiAgICB9KTtcbiAgICBcbiAgICBhd2FpdCBhZG1pbkNsaWVudC5jb25uZWN0KCk7XG4gICAgXG4gICAgLy8gRHJvcCB0ZXN0IGRhdGFiYXNlIGlmIGV4aXN0c1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBhZG1pbkNsaWVudC5xdWVyeShgRFJPUCBEQVRBQkFTRSBJRiBFWElTVFMgXCIke2RiTmFtZX1cImApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBJZ25vcmUgZXJyb3IgaWYgZGF0YWJhc2UgZG9lc24ndCBleGlzdFxuICAgIH1cbiAgICBcbiAgICAvLyBDcmVhdGUgdGVzdCBkYXRhYmFzZVxuICAgIGF3YWl0IGFkbWluQ2xpZW50LnF1ZXJ5KGBDUkVBVEUgREFUQUJBU0UgXCIke2RiTmFtZX1cImApO1xuICAgIFxuICAgIGF3YWl0IGFkbWluQ2xpZW50LmVuZCgpO1xuICAgIFxuICAgIGNvbnNvbGUubG9nKCfinIUgVGVzdCBkYXRhYmFzZSBjcmVhdGVkIHN1Y2Nlc3NmdWxseScpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUud2Fybign4pqg77iPIENvdWxkIG5vdCBzZXR1cCB0ZXN0IGRhdGFiYXNlIChtYXkgYWxyZWFkeSBleGlzdCk6JywgZXJyb3IubWVzc2FnZSk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0dXBUZXN0UmVkaXMoKSB7XG4gIGNvbnNvbGUubG9nKCfwn5S0IFNldHRpbmcgdXAgdGVzdCBSZWRpcy4uLicpO1xuICBcbiAgY29uc3QgcmVkaXNVcmwgPSBwcm9jZXNzLmVudi5SRURJU19VUkw7XG4gIGlmICghcmVkaXNVcmwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1RFU1RfUkVESVNfVVJMIGlzIG5vdCBzZXQnKTtcbiAgfVxuICBcbiAgdHJ5IHtcbiAgICBjb25zdCBjbGllbnQgPSBjcmVhdGVDbGllbnQoeyB1cmw6IHJlZGlzVXJsIH0pO1xuICAgIGF3YWl0IGNsaWVudC5jb25uZWN0KCk7XG4gICAgXG4gICAgLy8gQ2xlYXIgdGVzdCBSZWRpcyBkYXRhYmFzZVxuICAgIGF3YWl0IGNsaWVudC5mbHVzaERiKCk7XG4gICAgXG4gICAgYXdhaXQgY2xpZW50LmRpc2Nvbm5lY3QoKTtcbiAgICBcbiAgICBjb25zb2xlLmxvZygn4pyFIFRlc3QgUmVkaXMgc2V0dXAgY29tcGxldGUnKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLndhcm4oJ+KaoO+4jyBDb3VsZCBub3Qgc2V0dXAgdGVzdCBSZWRpczonLCBlcnJvci5tZXNzYWdlKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBydW5EYXRhYmFzZU1pZ3JhdGlvbnMoKSB7XG4gIGNvbnNvbGUubG9nKCfwn5SEIFJ1bm5pbmcgZGF0YWJhc2UgbWlncmF0aW9ucy4uLicpO1xuICBcbiAgdHJ5IHtcbiAgICAvLyBSdW4gUHJpc21hIG1pZ3JhdGlvbnNcbiAgICBleGVjU3luYygnbnB4IHByaXNtYSBtaWdyYXRlIGRlcGxveScsIHtcbiAgICAgIHN0ZGlvOiAnaW5oZXJpdCcsXG4gICAgICBlbnY6IHtcbiAgICAgICAgLi4ucHJvY2Vzcy5lbnYsXG4gICAgICAgIERBVEFCQVNFX1VSTDogcHJvY2Vzcy5lbnYuREFUQUJBU0VfVVJMLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBcbiAgICAvLyBHZW5lcmF0ZSBQcmlzbWEgY2xpZW50XG4gICAgZXhlY1N5bmMoJ25weCBwcmlzbWEgZ2VuZXJhdGUnLCB7XG4gICAgICBzdGRpbzogJ2luaGVyaXQnLFxuICAgIH0pO1xuICAgIFxuICAgIGNvbnNvbGUubG9nKCfinIUgRGF0YWJhc2UgbWlncmF0aW9ucyBjb21wbGV0ZWQnKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLndhcm4oJ+KaoO+4jyBDb3VsZCBub3QgcnVuIG1pZ3JhdGlvbnM6JywgZXJyb3IubWVzc2FnZSk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbFN0b3JlZFByb2NlZHVyZXMoKSB7XG4gIGNvbnNvbGUubG9nKCfwn5SnIEluc3RhbGxpbmcgc3RvcmVkIHByb2NlZHVyZXMuLi4nKTtcbiAgXG4gIHRyeSB7XG4gICAgY29uc3QgY2xpZW50ID0gbmV3IENsaWVudCh7IGNvbm5lY3Rpb25TdHJpbmc6IHByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTCB9KTtcbiAgICBhd2FpdCBjbGllbnQuY29ubmVjdCgpO1xuICAgIFxuICAgIC8vIFJlYWQgYW5kIGV4ZWN1dGUgc3RvcmVkIHByb2NlZHVyZXMgU1FMXG4gICAgY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuICAgIGNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG4gICAgXG4gICAgY29uc3Qgc3FsUGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9wcmlzbWEvbWlncmF0aW9ucy8wMDFfY3JlYXRlX21ldHJpY3NfcHJvY2VkdXJlcy5zcWwnKTtcbiAgICBcbiAgICBpZiAoZnMuZXhpc3RzU3luYyhzcWxQYXRoKSkge1xuICAgICAgY29uc3Qgc3FsID0gZnMucmVhZEZpbGVTeW5jKHNxbFBhdGgsICd1dGY4Jyk7XG4gICAgICBhd2FpdCBjbGllbnQucXVlcnkoc3FsKTtcbiAgICAgIGNvbnNvbGUubG9nKCfinIUgU3RvcmVkIHByb2NlZHVyZXMgaW5zdGFsbGVkJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUud2Fybign4pqg77iPIFN0b3JlZCBwcm9jZWR1cmVzIFNRTCBmaWxlIG5vdCBmb3VuZCcpO1xuICAgIH1cbiAgICBcbiAgICBhd2FpdCBjbGllbnQuZW5kKCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS53YXJuKCfimqDvuI8gQ291bGQgbm90IGluc3RhbGwgc3RvcmVkIHByb2NlZHVyZXM6JywgZXJyb3IubWVzc2FnZSk7XG4gIH1cbn1cblxuLy8gSGVhbHRoIGNoZWNrIGZ1bmN0aW9uc1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNoZWNrRGF0YWJhc2VIZWFsdGgoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIHRyeSB7XG4gICAgY29uc3QgY2xpZW50ID0gbmV3IENsaWVudCh7IGNvbm5lY3Rpb25TdHJpbmc6IHByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTCB9KTtcbiAgICBhd2FpdCBjbGllbnQuY29ubmVjdCgpO1xuICAgIGF3YWl0IGNsaWVudC5xdWVyeSgnU0VMRUNUIDEnKTtcbiAgICBhd2FpdCBjbGllbnQuZW5kKCk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjaGVja1JlZGlzSGVhbHRoKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICB0cnkge1xuICAgIGNvbnN0IGNsaWVudCA9IGNyZWF0ZUNsaWVudCh7IHVybDogcHJvY2Vzcy5lbnYuUkVESVNfVVJMIH0pO1xuICAgIGF3YWl0IGNsaWVudC5jb25uZWN0KCk7XG4gICAgYXdhaXQgY2xpZW50LnBpbmcoKTtcbiAgICBhd2FpdCBjbGllbnQuZGlzY29ubmVjdCgpO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG4vLyBVdGlsaXR5IGZ1bmN0aW9ucyBmb3IgdGVzdHNcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzZWVkVGVzdERhdGEoKSB7XG4gIGNvbnNvbGUubG9nKCfwn4yxIFNlZWRpbmcgdGVzdCBkYXRhLi4uJyk7XG4gIFxuICB0cnkge1xuICAgIGNvbnN0IHsgUHJpc21hQ2xpZW50IH0gPSByZXF1aXJlKCdAcHJpc21hL2NsaWVudCcpO1xuICAgIGNvbnN0IHByaXNtYSA9IG5ldyBQcmlzbWFDbGllbnQoKTtcbiAgICBcbiAgICAvLyBDcmVhdGUgdGVzdCBvcmdhbml6YXRpb25cbiAgICBjb25zdCBvcmdhbml6YXRpb24gPSBhd2FpdCBwcmlzbWEub3JnYW5pemF0aW9uLnVwc2VydCh7XG4gICAgICB3aGVyZTogeyBpZDogJzEyM2U0NTY3LWU4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMScgfSxcbiAgICAgIHVwZGF0ZToge30sXG4gICAgICBjcmVhdGU6IHtcbiAgICAgICAgaWQ6ICcxMjNlNDU2Ny1lODliLTEyZDMtYTQ1Ni00MjY2MTQxNzQwMDEnLFxuICAgICAgICBuYW1lOiAnVGVzdCBPcmdhbml6YXRpb24nLFxuICAgICAgICBzbHVnOiAndGVzdC1vcmcnLFxuICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgXG4gICAgLy8gQ3JlYXRlIHRlc3QgdXNlclxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBwcmlzbWEudXNlci51cHNlcnQoe1xuICAgICAgd2hlcmU6IHsgaWQ6ICcxMjNlNDU2Ny1lODliLTEyZDMtYTQ1Ni00MjY2MTQxNzQwMDAnIH0sXG4gICAgICB1cGRhdGU6IHt9LFxuICAgICAgY3JlYXRlOiB7XG4gICAgICAgIGlkOiAnMTIzZTQ1NjctZTg5Yi0xMmQzLWE0NTYtNDI2NjE0MTc0MDAwJyxcbiAgICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICAgICAgbmFtZTogJ1Rlc3QgVXNlcicsXG4gICAgICAgIG9yZ2FuaXphdGlvbklkOiBvcmdhbml6YXRpb24uaWQsXG4gICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBcbiAgICAvLyBDcmVhdGUgdGVzdCBjYW1wYWlnblxuICAgIGNvbnN0IGNhbXBhaWduID0gYXdhaXQgcHJpc21hLmNhbXBhaWduLnVwc2VydCh7XG4gICAgICB3aGVyZTogeyBpZDogJzEyM2U0NTY3LWU4OWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMicgfSxcbiAgICAgIHVwZGF0ZToge30sXG4gICAgICBjcmVhdGU6IHtcbiAgICAgICAgaWQ6ICcxMjNlNDU2Ny1lODliLTEyZDMtYTQ1Ni00MjY2MTQxNzQwMDInLFxuICAgICAgICBuYW1lOiAnVGVzdCBDYW1wYWlnbicsXG4gICAgICAgIG9yZ2FuaXphdGlvbklkOiBvcmdhbml6YXRpb24uaWQsXG4gICAgICAgIHN0YXR1czogJ0FDVElWRScsXG4gICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBcbiAgICAvLyBDcmVhdGUgdGVzdCBtZXRyaWNzIGRhdGFcbiAgICBjb25zdCB0b2RheSA9IG5ldyBEYXRlKCk7XG4gICAgdG9kYXkuc2V0SG91cnMoMCwgMCwgMCwgMCk7XG4gICAgXG4gICAgYXdhaXQgcHJpc21hLm1ldHJpY3NEYWlseS51cHNlcnQoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgY2FtcGFpZ25JZF9kYXRlOiB7XG4gICAgICAgICAgY2FtcGFpZ25JZDogY2FtcGFpZ24uaWQsXG4gICAgICAgICAgZGF0ZTogdG9kYXksXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgdXBkYXRlOiB7fSxcbiAgICAgIGNyZWF0ZToge1xuICAgICAgICBjYW1wYWlnbklkOiBjYW1wYWlnbi5pZCxcbiAgICAgICAgZGF0ZTogdG9kYXksXG4gICAgICAgIGltcHJlc3Npb25zOiAxMDAwMCxcbiAgICAgICAgY2xpY2tzOiA1MDAsXG4gICAgICAgIGNvbnZlcnNpb25zOiA1MCxcbiAgICAgICAgcmV2ZW51ZTogNTAwMCxcbiAgICAgICAgYWRTcGVuZDogMjAwMCxcbiAgICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICB9LFxuICAgIH0pO1xuICAgIFxuICAgIGF3YWl0IHByaXNtYS4kZGlzY29ubmVjdCgpO1xuICAgIFxuICAgIGNvbnNvbGUubG9nKCfinIUgVGVzdCBkYXRhIHNlZWRlZCBzdWNjZXNzZnVsbHknKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLndhcm4oJ+KaoO+4jyBDb3VsZCBub3Qgc2VlZCB0ZXN0IGRhdGE6JywgZXJyb3IubWVzc2FnZSk7XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNsZWFudXBUZXN0RGF0YSgpIHtcbiAgY29uc29sZS5sb2coJ/Cfp7kgQ2xlYW5pbmcgdXAgdGVzdCBkYXRhLi4uJyk7XG4gIFxuICB0cnkge1xuICAgIGNvbnN0IHsgUHJpc21hQ2xpZW50IH0gPSByZXF1aXJlKCdAcHJpc21hL2NsaWVudCcpO1xuICAgIGNvbnN0IHByaXNtYSA9IG5ldyBQcmlzbWFDbGllbnQoKTtcbiAgICBcbiAgICAvLyBEZWxldGUgaW4gcmV2ZXJzZSBvcmRlciBvZiBkZXBlbmRlbmNpZXNcbiAgICBhd2FpdCBwcmlzbWEubWV0cmljc0RhaWx5LmRlbGV0ZU1hbnkoe30pO1xuICAgIGF3YWl0IHByaXNtYS5tZXRyaWNzSG91cmx5LmRlbGV0ZU1hbnkoe30pO1xuICAgIGF3YWl0IHByaXNtYS5jb252ZXJzaW9uRXZlbnQuZGVsZXRlTWFueSh7fSk7XG4gICAgYXdhaXQgcHJpc21hLmZ1bm5lbFN0YWdlLmRlbGV0ZU1hbnkoe30pO1xuICAgIGF3YWl0IHByaXNtYS5jYW1wYWlnbi5kZWxldGVNYW55KHt9KTtcbiAgICBhd2FpdCBwcmlzbWEudXNlci5kZWxldGVNYW55KHt9KTtcbiAgICBhd2FpdCBwcmlzbWEub3JnYW5pemF0aW9uLmRlbGV0ZU1hbnkoe30pO1xuICAgIFxuICAgIGF3YWl0IHByaXNtYS4kZGlzY29ubmVjdCgpO1xuICAgIFxuICAgIGNvbnNvbGUubG9nKCfinIUgVGVzdCBkYXRhIGNsZWFuZWQgdXAnKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLndhcm4oJ+KaoO+4jyBDb3VsZCBub3QgY2xlYW51cCB0ZXN0IGRhdGE6JywgZXJyb3IubWVzc2FnZSk7XG4gIH1cbn1cblxuLy8gRXhwb3J0IGNvbmZpZ3VyYXRpb25cbmV4cG9ydCBjb25zdCB0ZXN0RW52aXJvbm1lbnRDb25maWcgPSB7XG4gIGRhdGFiYXNlOiB7XG4gICAgdXJsOiBwcm9jZXNzLmVudi5EQVRBQkFTRV9VUkwsXG4gICAgbWF4Q29ubmVjdGlvbnM6IDEwLFxuICAgIHRpbWVvdXQ6IDMwMDAwLFxuICB9LFxuICByZWRpczoge1xuICAgIHVybDogcHJvY2Vzcy5lbnYuUkVESVNfVVJMLFxuICAgIG1heFJldHJpZXM6IDMsXG4gICAgdGltZW91dDogNTAwMCxcbiAgfSxcbiAgYXBpOiB7XG4gICAgcG9ydDogcHJvY2Vzcy5lbnYuVEVTVF9QT1JUIHx8IDMwMDEsXG4gICAgdGltZW91dDogMzAwMDAsXG4gIH0sXG59OyJdLCJ2ZXJzaW9uIjozfQ==