8162241b5fa492fc00f3a24e2b53ca3f
"use strict";
/**
 * @jest-environment node
 */
// Simple WhatsApp Controller Tests - Isolated from setup.ts
describe('WhatsApp Controller - Simple Tests', () => {
    // Mock WhatsApp Service
    const mockWhatsAppService = {
        getConfig: jest.fn(),
        updateConfig: jest.fn(),
        sendMessage: jest.fn(),
        getMessages: jest.fn(),
        getTemplates: jest.fn(),
        createTemplate: jest.fn(),
        updateTemplate: jest.fn(),
        deleteTemplate: jest.fn(),
        sendBroadcast: jest.fn(),
        getMetrics: jest.fn(),
        handleWebhook: jest.fn()
    };
    // Simple WhatsApp Controller implementation for testing
    class TestWhatsAppController {
        whatsappService;
        constructor(whatsappService) {
            this.whatsappService = whatsappService;
        }
        async getConfig(req, res) {
            try {
                const userId = req.user?.id;
                if (!userId) {
                    return res.status(401).json({ error: 'Usuário não autenticado' });
                }
                const config = await this.whatsappService.getConfig(userId);
                return res.json({ config });
            }
            catch (error) {
                return res.status(500).json({ error: 'Erro interno do servidor' });
            }
        }
        async updateConfig(req, res) {
            try {
                const userId = req.user?.id;
                if (!userId) {
                    return res.status(401).json({ error: 'Usuário não autenticado' });
                }
                const config = await this.whatsappService.updateConfig(userId, req.body);
                return res.json({ config });
            }
            catch (error) {
                return res.status(500).json({ error: 'Erro interno do servidor' });
            }
        }
        async sendMessage(req, res) {
            try {
                const userId = req.user?.id;
                if (!userId) {
                    return res.status(401).json({ error: 'Usuário não autenticado' });
                }
                const { to, message } = req.body;
                if (!to || !message) {
                    return res.status(400).json({ error: 'Destinatário e mensagem são obrigatórios' });
                }
                const result = await this.whatsappService.sendMessage(userId, { to, message });
                return res.json({ message: result });
            }
            catch (error) {
                if (error.message.includes('não configurado') ||
                    error.message.includes('desativado') ||
                    error.message.includes('limite')) {
                    return res.status(400).json({ error: error.message });
                }
                return res.status(500).json({ error: 'Erro interno do servidor' });
            }
        }
        async getMessages(req, res) {
            try {
                const userId = req.user?.id;
                if (!userId) {
                    return res.status(401).json({ error: 'Usuário não autenticado' });
                }
                const page = parseInt(req.query.page) || 1;
                const limit = parseInt(req.query.limit) || 20;
                const result = await this.whatsappService.getMessages(userId, page, limit);
                return res.json(result);
            }
            catch (error) {
                return res.status(500).json({ error: 'Erro interno do servidor' });
            }
        }
    }
    let whatsappController;
    let mockReq;
    let mockRes;
    beforeEach(() => {
        // Reset all mocks
        jest.clearAllMocks();
        // Create controller instance
        whatsappController = new TestWhatsAppController(mockWhatsAppService);
        // Mock request and response objects
        mockReq = {
            user: { id: 'user-1' },
            body: {},
            query: {}
        };
        mockRes = {
            status: jest.fn().mockReturnThis(),
            json: jest.fn().mockReturnThis()
        };
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    describe('getConfig', () => {
        it('should return WhatsApp config successfully', async () => {
            const mockConfig = {
                id: 'config-1',
                userId: 'user-1',
                twilioAccountSid: 'test_sid',
                twilioPhoneNumber: '+1234567890',
                isActive: true,
                dailyLimit: 1000
            };
            mockWhatsAppService.getConfig.mockResolvedValue(mockConfig);
            await whatsappController.getConfig(mockReq, mockRes);
            expect(mockWhatsAppService.getConfig).toHaveBeenCalledWith('user-1');
            expect(mockRes.json).toHaveBeenCalledWith({ config: mockConfig });
        });
        it('should return 401 if user not authenticated', async () => {
            mockReq.user = null;
            await whatsappController.getConfig(mockReq, mockRes);
            expect(mockRes.status).toHaveBeenCalledWith(401);
            expect(mockRes.json).toHaveBeenCalledWith({ error: 'Usuário não autenticado' });
        });
        it('should return 500 on service error', async () => {
            mockWhatsAppService.getConfig.mockRejectedValue(new Error('Database error'));
            await whatsappController.getConfig(mockReq, mockRes);
            expect(mockRes.status).toHaveBeenCalledWith(500);
            expect(mockRes.json).toHaveBeenCalledWith({ error: 'Erro interno do servidor' });
        });
    });
    describe('updateConfig', () => {
        it('should update WhatsApp config successfully', async () => {
            const configData = {
                twilioAccountSid: 'new_sid',
                twilioAuthToken: 'new_token',
                twilioPhoneNumber: '+1234567890'
            };
            const updatedConfig = {
                id: 'config-1',
                userId: 'user-1',
                ...configData,
                isActive: true
            };
            mockReq.body = configData;
            mockWhatsAppService.updateConfig.mockResolvedValue(updatedConfig);
            await whatsappController.updateConfig(mockReq, mockRes);
            expect(mockWhatsAppService.updateConfig).toHaveBeenCalledWith('user-1', configData);
            expect(mockRes.json).toHaveBeenCalledWith({ config: updatedConfig });
        });
    });
    describe('sendMessage', () => {
        it('should send message successfully', async () => {
            const messageData = {
                to: '+1987654321',
                message: 'Hello, World!'
            };
            const sentMessage = {
                id: 'msg-1',
                userId: 'user-1',
                to: messageData.to,
                body: messageData.message,
                status: 'queued'
            };
            mockReq.body = messageData;
            mockWhatsAppService.sendMessage.mockResolvedValue(sentMessage);
            await whatsappController.sendMessage(mockReq, mockRes);
            expect(mockWhatsAppService.sendMessage).toHaveBeenCalledWith('user-1', messageData);
            expect(mockRes.json).toHaveBeenCalledWith({ message: sentMessage });
        });
        it('should return 400 if to or message is missing', async () => {
            mockReq.body = { to: '+1987654321' }; // missing message
            await whatsappController.sendMessage(mockReq, mockRes);
            expect(mockRes.status).toHaveBeenCalledWith(400);
            expect(mockRes.json).toHaveBeenCalledWith({
                error: 'Destinatário e mensagem são obrigatórios'
            });
        });
        it('should return 400 for WhatsApp service errors', async () => {
            mockReq.body = { to: '+1987654321', message: 'Hello' };
            mockWhatsAppService.sendMessage.mockRejectedValue(new Error('WhatsApp não configurado'));
            await whatsappController.sendMessage(mockReq, mockRes);
            expect(mockRes.status).toHaveBeenCalledWith(400);
            expect(mockRes.json).toHaveBeenCalledWith({
                error: 'WhatsApp não configurado'
            });
        });
    });
    describe('getMessages', () => {
        it('should return paginated messages', async () => {
            const mockResult = {
                messages: [
                    {
                        id: 'msg-1',
                        userId: 'user-1',
                        to: '+1987654321',
                        body: 'Hello',
                        status: 'delivered'
                    }
                ],
                total: 1,
                page: 1,
                limit: 20,
                totalPages: 1
            };
            mockWhatsAppService.getMessages.mockResolvedValue(mockResult);
            await whatsappController.getMessages(mockReq, mockRes);
            expect(mockWhatsAppService.getMessages).toHaveBeenCalledWith('user-1', 1, 20);
            expect(mockRes.json).toHaveBeenCalledWith(mockResult);
        });
        it('should use custom page and limit from query', async () => {
            mockReq.query = { page: '2', limit: '10' };
            const mockResult = {
                messages: [],
                total: 0,
                page: 2,
                limit: 10,
                totalPages: 0
            };
            mockWhatsAppService.getMessages.mockResolvedValue(mockResult);
            await whatsappController.getMessages(mockReq, mockRes);
            expect(mockWhatsAppService.getMessages).toHaveBeenCalledWith('user-1', 2, 10);
        });
    });
    // Basic functionality test
    it('should have basic Jest functionality working', () => {
        expect(1 + 1).toBe(2);
        expect('controller').toBe('controller');
        expect(true).toBeTruthy();
    });
    // Mock functionality test
    it('should have Jest mocks working for controller', () => {
        const mockFn = jest.fn();
        mockFn('controller-test');
        expect(mockFn).toHaveBeenCalledWith('controller-test');
        expect(mockFn).toHaveBeenCalledTimes(1);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxFbnpvIE1hcmNlbG9cXERlc2t0b3BcXFByb2pldG9zIEVtcHJlc2FcXFNhYXMgVXRtaWZ5XFx1dG1pZnktY2xvbmVcXGFwcHNcXGFwaVxcc3JjXFx0ZXN0c1xcd2hhdHNhcHAuY29udHJvbGxlci5zaW1wbGUudGVzdC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7QUFFSCw0REFBNEQ7QUFDNUQsUUFBUSxDQUFDLG9DQUFvQyxFQUFFLEdBQUcsRUFBRTtJQUNsRCx3QkFBd0I7SUFDeEIsTUFBTSxtQkFBbUIsR0FBRztRQUMxQixTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNwQixZQUFZLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUN2QixXQUFXLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUN0QixXQUFXLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUN0QixZQUFZLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUN2QixjQUFjLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUN6QixjQUFjLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUN6QixjQUFjLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUN6QixhQUFhLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUN4QixVQUFVLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNyQixhQUFhLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtLQUN6QixDQUFBO0lBRUQsd0RBQXdEO0lBQ3hELE1BQU0sc0JBQXNCO1FBQ047UUFBcEIsWUFBb0IsZUFBb0I7WUFBcEIsb0JBQWUsR0FBZixlQUFlLENBQUs7UUFBRyxDQUFDO1FBRTVDLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBUSxFQUFFLEdBQVE7WUFDaEMsSUFBSSxDQUFDO2dCQUNILE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFBO2dCQUMzQixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7b0JBQ1os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LENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUN6QyxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMsQ0FBQyxDQUFBIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcRW56byBNYXJjZWxvXFxEZXNrdG9wXFxQcm9qZXRvcyBFbXByZXNhXFxTYWFzIFV0bWlmeVxcdXRtaWZ5LWNsb25lXFxhcHBzXFxhcGlcXHNyY1xcdGVzdHNcXHdoYXRzYXBwLmNvbnRyb2xsZXIuc2ltcGxlLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAamVzdC1lbnZpcm9ubWVudCBub2RlXG4gKi9cblxuLy8gU2ltcGxlIFdoYXRzQXBwIENvbnRyb2xsZXIgVGVzdHMgLSBJc29sYXRlZCBmcm9tIHNldHVwLnRzXG5kZXNjcmliZSgnV2hhdHNBcHAgQ29udHJvbGxlciAtIFNpbXBsZSBUZXN0cycsICgpID0+IHtcbiAgLy8gTW9jayBXaGF0c0FwcCBTZXJ2aWNlXG4gIGNvbnN0IG1vY2tXaGF0c0FwcFNlcnZpY2UgPSB7XG4gICAgZ2V0Q29uZmlnOiBqZXN0LmZuKCksXG4gICAgdXBkYXRlQ29uZmlnOiBqZXN0LmZuKCksXG4gICAgc2VuZE1lc3NhZ2U6IGplc3QuZm4oKSxcbiAgICBnZXRNZXNzYWdlczogamVzdC5mbigpLFxuICAgIGdldFRlbXBsYXRlczogamVzdC5mbigpLFxuICAgIGNyZWF0ZVRlbXBsYXRlOiBqZXN0LmZuKCksXG4gICAgdXBkYXRlVGVtcGxhdGU6IGplc3QuZm4oKSxcbiAgICBkZWxldGVUZW1wbGF0ZTogamVzdC5mbigpLFxuICAgIHNlbmRCcm9hZGNhc3Q6IGplc3QuZm4oKSxcbiAgICBnZXRNZXRyaWNzOiBqZXN0LmZuKCksXG4gICAgaGFuZGxlV2ViaG9vazogamVzdC5mbigpXG4gIH1cblxuICAvLyBTaW1wbGUgV2hhdHNBcHAgQ29udHJvbGxlciBpbXBsZW1lbnRhdGlvbiBmb3IgdGVzdGluZ1xuICBjbGFzcyBUZXN0V2hhdHNBcHBDb250cm9sbGVyIHtcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHdoYXRzYXBwU2VydmljZTogYW55KSB7fVxuXG4gICAgYXN5bmMgZ2V0Q29uZmlnKHJlcTogYW55LCByZXM6IGFueSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXI/LmlkXG4gICAgICAgIGlmICghdXNlcklkKSB7XG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdVc3XDoXJpbyBuw6NvIGF1dGVudGljYWRvJyB9KVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY29uZmlnID0gYXdhaXQgdGhpcy53aGF0c2FwcFNlcnZpY2UuZ2V0Q29uZmlnKHVzZXJJZClcbiAgICAgICAgcmV0dXJuIHJlcy5qc29uKHsgY29uZmlnIH0pXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0Vycm8gaW50ZXJubyBkbyBzZXJ2aWRvcicgfSlcbiAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyB1cGRhdGVDb25maWcocmVxOiBhbnksIHJlczogYW55KSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB1c2VySWQgPSByZXEudXNlcj8uaWRcbiAgICAgICAgaWYgKCF1c2VySWQpIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ1VzdcOhcmlvIG7Do28gYXV0ZW50aWNhZG8nIH0pXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjb25maWcgPSBhd2FpdCB0aGlzLndoYXRzYXBwU2VydmljZS51cGRhdGVDb25maWcodXNlcklkLCByZXEuYm9keSlcbiAgICAgICAgcmV0dXJuIHJlcy5qc29uKHsgY29uZmlnIH0pXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0Vycm8gaW50ZXJubyBkbyBzZXJ2aWRvcicgfSlcbiAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBzZW5kTWVzc2FnZShyZXE6IGFueSwgcmVzOiBhbnkpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyPy5pZFxuICAgICAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnVXN1w6FyaW8gbsOjbyBhdXRlbnRpY2FkbycgfSlcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHsgdG8sIG1lc3NhZ2UgfSA9IHJlcS5ib2R5XG4gICAgICAgIGlmICghdG8gfHwgIW1lc3NhZ2UpIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogJ0Rlc3RpbmF0w6FyaW8gZSBtZW5zYWdlbSBzw6NvIG9icmlnYXTDs3Jpb3MnIH0pXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLndoYXRzYXBwU2VydmljZS5zZW5kTWVzc2FnZSh1c2VySWQsIHsgdG8sIG1lc3NhZ2UgfSlcbiAgICAgICAgcmV0dXJuIHJlcy5qc29uKHsgbWVzc2FnZTogcmVzdWx0IH0pXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnbsOjbyBjb25maWd1cmFkbycpIHx8IFxuICAgICAgICAgICAgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnZGVzYXRpdmFkbycpIHx8IFxuICAgICAgICAgICAgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnbGltaXRlJykpIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogZXJyb3IubWVzc2FnZSB9KVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnRXJybyBpbnRlcm5vIGRvIHNlcnZpZG9yJyB9KVxuICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGdldE1lc3NhZ2VzKHJlcTogYW55LCByZXM6IGFueSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXI/LmlkXG4gICAgICAgIGlmICghdXNlcklkKSB7XG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdVc3XDoXJpbyBuw6NvIGF1dGVudGljYWRvJyB9KVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcGFnZSA9IHBhcnNlSW50KHJlcS5xdWVyeS5wYWdlKSB8fCAxXG4gICAgICAgIGNvbnN0IGxpbWl0ID0gcGFyc2VJbnQocmVxLnF1ZXJ5LmxpbWl0KSB8fCAyMFxuXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMud2hhdHNhcHBTZXJ2aWNlLmdldE1lc3NhZ2VzKHVzZXJJZCwgcGFnZSwgbGltaXQpXG4gICAgICAgIHJldHVybiByZXMuanNvbihyZXN1bHQpXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogJ0Vycm8gaW50ZXJubyBkbyBzZXJ2aWRvcicgfSlcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBsZXQgd2hhdHNhcHBDb250cm9sbGVyOiBUZXN0V2hhdHNBcHBDb250cm9sbGVyXG4gIGxldCBtb2NrUmVxOiBhbnlcbiAgbGV0IG1vY2tSZXM6IGFueVxuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIC8vIFJlc2V0IGFsbCBtb2Nrc1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpXG4gICAgXG4gICAgLy8gQ3JlYXRlIGNvbnRyb2xsZXIgaW5zdGFuY2VcbiAgICB3aGF0c2FwcENvbnRyb2xsZXIgPSBuZXcgVGVzdFdoYXRzQXBwQ29udHJvbGxlcihtb2NrV2hhdHNBcHBTZXJ2aWNlKVxuXG4gICAgLy8gTW9jayByZXF1ZXN0IGFuZCByZXNwb25zZSBvYmplY3RzXG4gICAgbW9ja1JlcSA9IHtcbiAgICAgIHVzZXI6IHsgaWQ6ICd1c2VyLTEnIH0sXG4gICAgICBib2R5OiB7fSxcbiAgICAgIHF1ZXJ5OiB7fVxuICAgIH1cblxuICAgIG1vY2tSZXMgPSB7XG4gICAgICBzdGF0dXM6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgICAganNvbjogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKClcbiAgICB9XG4gIH0pXG5cbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKVxuICB9KVxuXG4gIGRlc2NyaWJlKCdnZXRDb25maWcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gV2hhdHNBcHAgY29uZmlnIHN1Y2Nlc3NmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tDb25maWcgPSB7XG4gICAgICAgIGlkOiAnY29uZmlnLTEnLFxuICAgICAgICB1c2VySWQ6ICd1c2VyLTEnLFxuICAgICAgICB0d2lsaW9BY2NvdW50U2lkOiAndGVzdF9zaWQnLFxuICAgICAgICB0d2lsaW9QaG9uZU51bWJlcjogJysxMjM0NTY3ODkwJyxcbiAgICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICAgIGRhaWx5TGltaXQ6IDEwMDBcbiAgICAgIH1cblxuICAgICAgbW9ja1doYXRzQXBwU2VydmljZS5nZXRDb25maWcubW9ja1Jlc29sdmVkVmFsdWUobW9ja0NvbmZpZylcblxuICAgICAgYXdhaXQgd2hhdHNhcHBDb250cm9sbGVyLmdldENvbmZpZyhtb2NrUmVxLCBtb2NrUmVzKVxuXG4gICAgICBleHBlY3QobW9ja1doYXRzQXBwU2VydmljZS5nZXRDb25maWcpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCd1c2VyLTEnKVxuICAgICAgZXhwZWN0KG1vY2tSZXMuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoeyBjb25maWc6IG1vY2tDb25maWcgfSlcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gNDAxIGlmIHVzZXIgbm90IGF1dGhlbnRpY2F0ZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrUmVxLnVzZXIgPSBudWxsXG5cbiAgICAgIGF3YWl0IHdoYXRzYXBwQ29udHJvbGxlci5nZXRDb25maWcobW9ja1JlcSwgbW9ja1JlcylcblxuICAgICAgZXhwZWN0KG1vY2tSZXMuc3RhdHVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCg0MDEpXG4gICAgICBleHBlY3QobW9ja1Jlcy5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7IGVycm9yOiAnVXN1w6FyaW8gbsOjbyBhdXRlbnRpY2FkbycgfSlcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gNTAwIG9uIHNlcnZpY2UgZXJyb3InLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrV2hhdHNBcHBTZXJ2aWNlLmdldENvbmZpZy5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgRXJyb3IoJ0RhdGFiYXNlIGVycm9yJykpXG5cbiAgICAgIGF3YWl0IHdoYXRzYXBwQ29udHJvbGxlci5nZXRDb25maWcobW9ja1JlcSwgbW9ja1JlcylcblxuICAgICAgZXhwZWN0KG1vY2tSZXMuc3RhdHVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCg1MDApXG4gICAgICBleHBlY3QobW9ja1Jlcy5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7IGVycm9yOiAnRXJybyBpbnRlcm5vIGRvIHNlcnZpZG9yJyB9KVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ3VwZGF0ZUNvbmZpZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHVwZGF0ZSBXaGF0c0FwcCBjb25maWcgc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgY29uZmlnRGF0YSA9IHtcbiAgICAgICAgdHdpbGlvQWNjb3VudFNpZDogJ25ld19zaWQnLFxuICAgICAgICB0d2lsaW9BdXRoVG9rZW46ICduZXdfdG9rZW4nLFxuICAgICAgICB0d2lsaW9QaG9uZU51bWJlcjogJysxMjM0NTY3ODkwJ1xuICAgICAgfVxuXG4gICAgICBjb25zdCB1cGRhdGVkQ29uZmlnID0ge1xuICAgICAgICBpZDogJ2NvbmZpZy0xJyxcbiAgICAgICAgdXNlcklkOiAndXNlci0xJyxcbiAgICAgICAgLi4uY29uZmlnRGF0YSxcbiAgICAgICAgaXNBY3RpdmU6IHRydWVcbiAgICAgIH1cblxuICAgICAgbW9ja1JlcS5ib2R5ID0gY29uZmlnRGF0YVxuICAgICAgbW9ja1doYXRzQXBwU2VydmljZS51cGRhdGVDb25maWcubW9ja1Jlc29sdmVkVmFsdWUodXBkYXRlZENvbmZpZylcblxuICAgICAgYXdhaXQgd2hhdHNhcHBDb250cm9sbGVyLnVwZGF0ZUNvbmZpZyhtb2NrUmVxLCBtb2NrUmVzKVxuXG4gICAgICBleHBlY3QobW9ja1doYXRzQXBwU2VydmljZS51cGRhdGVDb25maWcpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCd1c2VyLTEnLCBjb25maWdEYXRhKVxuICAgICAgZXhwZWN0KG1vY2tSZXMuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoeyBjb25maWc6IHVwZGF0ZWRDb25maWcgfSlcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdzZW5kTWVzc2FnZScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHNlbmQgbWVzc2FnZSBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBtZXNzYWdlRGF0YSA9IHtcbiAgICAgICAgdG86ICcrMTk4NzY1NDMyMScsXG4gICAgICAgIG1lc3NhZ2U6ICdIZWxsbywgV29ybGQhJ1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzZW50TWVzc2FnZSA9IHtcbiAgICAgICAgaWQ6ICdtc2ctMScsXG4gICAgICAgIHVzZXJJZDogJ3VzZXItMScsXG4gICAgICAgIHRvOiBtZXNzYWdlRGF0YS50byxcbiAgICAgICAgYm9keTogbWVzc2FnZURhdGEubWVzc2FnZSxcbiAgICAgICAgc3RhdHVzOiAncXVldWVkJ1xuICAgICAgfVxuXG4gICAgICBtb2NrUmVxLmJvZHkgPSBtZXNzYWdlRGF0YVxuICAgICAgbW9ja1doYXRzQXBwU2VydmljZS5zZW5kTWVzc2FnZS5tb2NrUmVzb2x2ZWRWYWx1ZShzZW50TWVzc2FnZSlcblxuICAgICAgYXdhaXQgd2hhdHNhcHBDb250cm9sbGVyLnNlbmRNZXNzYWdlKG1vY2tSZXEsIG1vY2tSZXMpXG5cbiAgICAgIGV4cGVjdChtb2NrV2hhdHNBcHBTZXJ2aWNlLnNlbmRNZXNzYWdlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgndXNlci0xJywgbWVzc2FnZURhdGEpXG4gICAgICBleHBlY3QobW9ja1Jlcy5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7IG1lc3NhZ2U6IHNlbnRNZXNzYWdlIH0pXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIDQwMCBpZiB0byBvciBtZXNzYWdlIGlzIG1pc3NpbmcnLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrUmVxLmJvZHkgPSB7IHRvOiAnKzE5ODc2NTQzMjEnIH0gLy8gbWlzc2luZyBtZXNzYWdlXG5cbiAgICAgIGF3YWl0IHdoYXRzYXBwQ29udHJvbGxlci5zZW5kTWVzc2FnZShtb2NrUmVxLCBtb2NrUmVzKVxuXG4gICAgICBleHBlY3QobW9ja1Jlcy5zdGF0dXMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKDQwMClcbiAgICAgIGV4cGVjdChtb2NrUmVzLmpzb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHsgXG4gICAgICAgIGVycm9yOiAnRGVzdGluYXTDoXJpbyBlIG1lbnNhZ2VtIHPDo28gb2JyaWdhdMOzcmlvcycgXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiA0MDAgZm9yIFdoYXRzQXBwIHNlcnZpY2UgZXJyb3JzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbW9ja1JlcS5ib2R5ID0geyB0bzogJysxOTg3NjU0MzIxJywgbWVzc2FnZTogJ0hlbGxvJyB9XG4gICAgICBtb2NrV2hhdHNBcHBTZXJ2aWNlLnNlbmRNZXNzYWdlLm1vY2tSZWplY3RlZFZhbHVlKFxuICAgICAgICBuZXcgRXJyb3IoJ1doYXRzQXBwIG7Do28gY29uZmlndXJhZG8nKVxuICAgICAgKVxuXG4gICAgICBhd2FpdCB3aGF0c2FwcENvbnRyb2xsZXIuc2VuZE1lc3NhZ2UobW9ja1JlcSwgbW9ja1JlcylcblxuICAgICAgZXhwZWN0KG1vY2tSZXMuc3RhdHVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCg0MDApXG4gICAgICBleHBlY3QobW9ja1Jlcy5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7IFxuICAgICAgICBlcnJvcjogJ1doYXRzQXBwIG7Do28gY29uZmlndXJhZG8nIFxuICAgICAgfSlcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdnZXRNZXNzYWdlcycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHVybiBwYWdpbmF0ZWQgbWVzc2FnZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrUmVzdWx0ID0ge1xuICAgICAgICBtZXNzYWdlczogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIGlkOiAnbXNnLTEnLFxuICAgICAgICAgICAgdXNlcklkOiAndXNlci0xJyxcbiAgICAgICAgICAgIHRvOiAnKzE5ODc2NTQzMjEnLFxuICAgICAgICAgICAgYm9keTogJ0hlbGxvJyxcbiAgICAgICAgICAgIHN0YXR1czogJ2RlbGl2ZXJlZCdcbiAgICAgICAgICB9XG4gICAgICAgIF0sXG4gICAgICAgIHRvdGFsOiAxLFxuICAgICAgICBwYWdlOiAxLFxuICAgICAgICBsaW1pdDogMjAsXG4gICAgICAgIHRvdGFsUGFnZXM6IDFcbiAgICAgIH1cblxuICAgICAgbW9ja1doYXRzQXBwU2VydmljZS5nZXRNZXNzYWdlcy5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrUmVzdWx0KVxuXG4gICAgICBhd2FpdCB3aGF0c2FwcENvbnRyb2xsZXIuZ2V0TWVzc2FnZXMobW9ja1JlcSwgbW9ja1JlcylcblxuICAgICAgZXhwZWN0KG1vY2tXaGF0c0FwcFNlcnZpY2UuZ2V0TWVzc2FnZXMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCd1c2VyLTEnLCAxLCAyMClcbiAgICAgIGV4cGVjdChtb2NrUmVzLmpzb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKG1vY2tSZXN1bHQpXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgdXNlIGN1c3RvbSBwYWdlIGFuZCBsaW1pdCBmcm9tIHF1ZXJ5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgbW9ja1JlcS5xdWVyeSA9IHsgcGFnZTogJzInLCBsaW1pdDogJzEwJyB9XG4gICAgICBcbiAgICAgIGNvbnN0IG1vY2tSZXN1bHQgPSB7XG4gICAgICAgIG1lc3NhZ2VzOiBbXSxcbiAgICAgICAgdG90YWw6IDAsXG4gICAgICAgIHBhZ2U6IDIsXG4gICAgICAgIGxpbWl0OiAxMCxcbiAgICAgICAgdG90YWxQYWdlczogMFxuICAgICAgfVxuXG4gICAgICBtb2NrV2hhdHNBcHBTZXJ2aWNlLmdldE1lc3NhZ2VzLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tSZXN1bHQpXG5cbiAgICAgIGF3YWl0IHdoYXRzYXBwQ29udHJvbGxlci5nZXRNZXNzYWdlcyhtb2NrUmVxLCBtb2NrUmVzKVxuXG4gICAgICBleHBlY3QobW9ja1doYXRzQXBwU2VydmljZS5nZXRNZXNzYWdlcykudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ3VzZXItMScsIDIsIDEwKVxuICAgIH0pXG4gIH0pXG5cbiAgLy8gQmFzaWMgZnVuY3Rpb25hbGl0eSB0ZXN0XG4gIGl0KCdzaG91bGQgaGF2ZSBiYXNpYyBKZXN0IGZ1bmN0aW9uYWxpdHkgd29ya2luZycsICgpID0+IHtcbiAgICBleHBlY3QoMSArIDEpLnRvQmUoMilcbiAgICBleHBlY3QoJ2NvbnRyb2xsZXInKS50b0JlKCdjb250cm9sbGVyJylcbiAgICBleHBlY3QodHJ1ZSkudG9CZVRydXRoeSgpXG4gIH0pXG5cbiAgLy8gTW9jayBmdW5jdGlvbmFsaXR5IHRlc3RcbiAgaXQoJ3Nob3VsZCBoYXZlIEplc3QgbW9ja3Mgd29ya2luZyBmb3IgY29udHJvbGxlcicsICgpID0+IHtcbiAgICBjb25zdCBtb2NrRm4gPSBqZXN0LmZuKClcbiAgICBtb2NrRm4oJ2NvbnRyb2xsZXItdGVzdCcpXG4gICAgZXhwZWN0KG1vY2tGbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ2NvbnRyb2xsZXItdGVzdCcpXG4gICAgZXhwZWN0KG1vY2tGbikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpXG4gIH0pXG59KSJdLCJ2ZXJzaW9uIjozfQ==