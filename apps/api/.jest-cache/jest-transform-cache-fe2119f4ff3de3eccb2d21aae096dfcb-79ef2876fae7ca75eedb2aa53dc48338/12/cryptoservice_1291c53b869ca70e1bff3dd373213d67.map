{"version":3,"names":["cov_zxnczykvr","actualCoverage","Injectable","ConfigService","crypto","s","CryptoService","configService","algorithm","keyLength","ivLength","tagLength","encryptionKey","constructor","f","key","get","b","Error","scryptSync","encrypt","text","iv","randomBytes","cipher","createCipher","setAAD","Buffer","from","encrypted","update","final","tag","getAuthTag","result","toString","error","message","decrypt","encryptedData","ivHex","slice","tagHex","decipher","createDecipher","setAuthTag","decrypted","generateRandomString","length","hash","createHash","digest","isValidEncryptedData","minLength","__decorate","_a","Object"],"sources":["C:\\Users\\Enzo Marcelo\\Desktop\\Projetos Empresa\\Saas Utmify\\utmify-clone\\apps\\api\\src\\services\\crypto.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport * as crypto from 'crypto';\n\n@Injectable()\nexport class CryptoService {\n  private readonly algorithm = 'aes-256-gcm';\n  private readonly keyLength = 32; // 256 bits\n  private readonly ivLength = 16; // 128 bits\n  private readonly tagLength = 16; // 128 bits\n  private readonly encryptionKey: Buffer;\n\n  constructor(private readonly configService: ConfigService) {\n    const key = this.configService.get<string>('ENCRYPTION_KEY');\n    if (!key) {\n      throw new Error('ENCRYPTION_KEY environment variable is required');\n    }\n    \n    // Derive a consistent key from the environment variable\n    this.encryptionKey = crypto.scryptSync(key, 'salt', this.keyLength);\n  }\n\n  /**\n   * Encrypt a string value\n   */\n  encrypt(text: string): string {\n    try {\n      const iv = crypto.randomBytes(this.ivLength);\n      const cipher = crypto.createCipher(this.algorithm, this.encryptionKey);\n      cipher.setAAD(Buffer.from('utmify-meta-ads', 'utf8'));\n      \n      let encrypted = cipher.update(text, 'utf8', 'hex');\n      encrypted += cipher.final('hex');\n      \n      const tag = cipher.getAuthTag();\n      \n      // Combine iv + tag + encrypted data\n      const result = iv.toString('hex') + tag.toString('hex') + encrypted;\n      return result;\n    } catch (error) {\n      throw new Error(`Encryption failed: ${error.message}`);\n    }\n  }\n\n  /**\n   * Decrypt a string value\n   */\n  decrypt(encryptedData: string): string {\n    try {\n      // Extract iv, tag, and encrypted data\n      const ivHex = encryptedData.slice(0, this.ivLength * 2);\n      const tagHex = encryptedData.slice(this.ivLength * 2, (this.ivLength + this.tagLength) * 2);\n      const encrypted = encryptedData.slice((this.ivLength + this.tagLength) * 2);\n      \n      const iv = Buffer.from(ivHex, 'hex');\n      const tag = Buffer.from(tagHex, 'hex');\n      \n      const decipher = crypto.createDecipher(this.algorithm, this.encryptionKey);\n      decipher.setAAD(Buffer.from('utmify-meta-ads', 'utf8'));\n      decipher.setAuthTag(tag);\n      \n      let decrypted = decipher.update(encrypted, 'hex', 'utf8');\n      decrypted += decipher.final('utf8');\n      \n      return decrypted;\n    } catch (error) {\n      throw new Error(`Decryption failed: ${error.message}`);\n    }\n  }\n\n  /**\n   * Generate a secure random string\n   */\n  generateRandomString(length: number = 32): string {\n    return crypto.randomBytes(length).toString('hex');\n  }\n\n  /**\n   * Hash a string using SHA-256\n   */\n  hash(text: string): string {\n    return crypto.createHash('sha256').update(text).digest('hex');\n  }\n\n  /**\n   * Verify if encrypted data is valid\n   */\n  isValidEncryptedData(encryptedData: string): boolean {\n    try {\n      // Check minimum length (iv + tag + some data)\n      const minLength = (this.ivLength + this.tagLength) * 2 + 2;\n      if (encryptedData.length < minLength) {\n        return false;\n      }\n      \n      // Try to decrypt (will throw if invalid)\n      this.decrypt(encryptedData);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n}"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAMmB;IAAAA,aAAA,YAAAA,CAAA;MAAA,OAAAC,cAAA;IAAA;EAAA;EAAA,OAAAA,cAAA;AAAA;AAAAD,aAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AANnB,SAASE,UAAU,QAAQ,gBAAgB;AAC3C,SAASC,aAAa,QAAQ,gBAAgB;AAC9C,OAAO,KAAKC,MAAM,MAAM,QAAQ;AAAC;AAAAJ,aAAA,GAAAK,CAAA;AAG1B,IAAMC,aAAa,GAAnB,MAAMA,aAAa;EAOKC,aAAA;EANZC,SAAS;EAAA;EAAA,CAAAR,aAAA,GAAAK,CAAA,QAAG,aAAa;EACzBI,SAAS;EAAA;EAAA,CAAAT,aAAA,GAAAK,CAAA,QAAG,EAAE,EAAC,CAAC;EAChBK,QAAQ;EAAA;EAAA,CAAAV,aAAA,GAAAK,CAAA,QAAG,EAAE,EAAC,CAAC;EACfM,SAAS;EAAA;EAAA,CAAAX,aAAA,GAAAK,CAAA,QAAG,EAAE,EAAC,CAAC;EAChBO,aAAa;EAE9BC,YAA6BN,aAA4B;IAAA;IAAAP,aAAA,GAAAc,CAAA;IAAAd,aAAA,GAAAK,CAAA;IAA5B,KAAAE,aAAa,GAAbA,aAAa;IACxC,MAAMQ,GAAG;IAAA;IAAA,CAAAf,aAAA,GAAAK,CAAA,QAAG,IAAI,CAACE,aAAa,CAACS,GAAG,CAAS,gBAAgB,CAAC;IAAC;IAAAhB,aAAA,GAAAK,CAAA;IAC7D,IAAI,CAACU,GAAG,EAAE;MAAA;MAAAf,aAAA,GAAAiB,CAAA;MAAAjB,aAAA,GAAAK,CAAA;MACR,MAAM,IAAIa,KAAK,CAAC,iDAAiD,CAAC;IACpE,CAAC;IAAA;IAAA;MAAAlB,aAAA,GAAAiB,CAAA;IAAA;IAED;IAAAjB,aAAA,GAAAK,CAAA;IACA,IAAI,CAACO,aAAa,GAAGR,MAAM,CAACe,UAAU,CAACJ,GAAG,EAAE,MAAM,EAAE,IAAI,CAACN,SAAS,CAAC;EACrE;EAEA;;;EAGAW,OAAOA,CAACC,IAAY;IAAA;IAAArB,aAAA,GAAAc,CAAA;IAAAd,aAAA,GAAAK,CAAA;IAClB,IAAI;MACF,MAAMiB,EAAE;MAAA;MAAA,CAAAtB,aAAA,GAAAK,CAAA,QAAGD,MAAM,CAACmB,WAAW,CAAC,IAAI,CAACb,QAAQ,CAAC;MAC5C,MAAMc,MAAM;MAAA;MAAA,CAAAxB,aAAA,GAAAK,CAAA,QAAGD,MAAM,CAACqB,YAAY,CAAC,IAAI,CAACjB,SAAS,EAAE,IAAI,CAACI,aAAa,CAAC;MAAC;MAAAZ,aAAA,GAAAK,CAAA;MACvEmB,MAAM,CAACE,MAAM,CAACC,MAAM,CAACC,IAAI,CAAC,iBAAiB,EAAE,MAAM,CAAC,CAAC;MAErD,IAAIC,SAAS;MAAA;MAAA,CAAA7B,aAAA,GAAAK,CAAA,QAAGmB,MAAM,CAACM,MAAM,CAACT,IAAI,EAAE,MAAM,EAAE,KAAK,CAAC;MAAC;MAAArB,aAAA,GAAAK,CAAA;MACnDwB,SAAS,IAAIL,MAAM,CAACO,KAAK,CAAC,KAAK,CAAC;MAEhC,MAAMC,GAAG;MAAA;MAAA,CAAAhC,aAAA,GAAAK,CAAA,QAAGmB,MAAM,CAACS,UAAU,EAAE;MAE/B;MACA,MAAMC,MAAM;MAAA;MAAA,CAAAlC,aAAA,GAAAK,CAAA,QAAGiB,EAAE,CAACa,QAAQ,CAAC,KAAK,CAAC,GAAGH,GAAG,CAACG,QAAQ,CAAC,KAAK,CAAC,GAAGN,SAAS;MAAC;MAAA7B,aAAA,GAAAK,CAAA;MACpE,OAAO6B,MAAM;IACf,CAAC,CAAC,OAAOE,KAAK,EAAE;MAAA;MAAApC,aAAA,GAAAK,CAAA;MACd,MAAM,IAAIa,KAAK,CAAC,sBAAsBkB,KAAK,CAACC,OAAO,EAAE,CAAC;IACxD;EACF;EAEA;;;EAGAC,OAAOA,CAACC,aAAqB;IAAA;IAAAvC,aAAA,GAAAc,CAAA;IAAAd,aAAA,GAAAK,CAAA;IAC3B,IAAI;MACF;MACA,MAAMmC,KAAK;MAAA;MAAA,CAAAxC,aAAA,GAAAK,CAAA,QAAGkC,aAAa,CAACE,KAAK,CAAC,CAAC,EAAE,IAAI,CAAC/B,QAAQ,GAAG,CAAC,CAAC;MACvD,MAAMgC,MAAM;MAAA;MAAA,CAAA1C,aAAA,GAAAK,CAAA,QAAGkC,aAAa,CAACE,KAAK,CAAC,IAAI,CAAC/B,QAAQ,GAAG,CAAC,EAAE,CAAC,IAAI,CAACA,QAAQ,GAAG,IAAI,CAACC,SAAS,IAAI,CAAC,CAAC;MAC3F,MAAMkB,SAAS;MAAA;MAAA,CAAA7B,aAAA,GAAAK,CAAA,QAAGkC,aAAa,CAACE,KAAK,CAAC,CAAC,IAAI,CAAC/B,QAAQ,GAAG,IAAI,CAACC,SAAS,IAAI,CAAC,CAAC;MAE3E,MAAMW,EAAE;MAAA;MAAA,CAAAtB,aAAA,GAAAK,CAAA,QAAGsB,MAAM,CAACC,IAAI,CAACY,KAAK,EAAE,KAAK,CAAC;MACpC,MAAMR,GAAG;MAAA;MAAA,CAAAhC,aAAA,GAAAK,CAAA,QAAGsB,MAAM,CAACC,IAAI,CAACc,MAAM,EAAE,KAAK,CAAC;MAEtC,MAAMC,QAAQ;MAAA;MAAA,CAAA3C,aAAA,GAAAK,CAAA,QAAGD,MAAM,CAACwC,cAAc,CAAC,IAAI,CAACpC,SAAS,EAAE,IAAI,CAACI,aAAa,CAAC;MAAC;MAAAZ,aAAA,GAAAK,CAAA;MAC3EsC,QAAQ,CAACjB,MAAM,CAACC,MAAM,CAACC,IAAI,CAAC,iBAAiB,EAAE,MAAM,CAAC,CAAC;MAAC;MAAA5B,aAAA,GAAAK,CAAA;MACxDsC,QAAQ,CAACE,UAAU,CAACb,GAAG,CAAC;MAExB,IAAIc,SAAS;MAAA;MAAA,CAAA9C,aAAA,GAAAK,CAAA,QAAGsC,QAAQ,CAACb,MAAM,CAACD,SAAS,EAAE,KAAK,EAAE,MAAM,CAAC;MAAC;MAAA7B,aAAA,GAAAK,CAAA;MAC1DyC,SAAS,IAAIH,QAAQ,CAACZ,KAAK,CAAC,MAAM,CAAC;MAAC;MAAA/B,aAAA,GAAAK,CAAA;MAEpC,OAAOyC,SAAS;IAClB,CAAC,CAAC,OAAOV,KAAK,EAAE;MAAA;MAAApC,aAAA,GAAAK,CAAA;MACd,MAAM,IAAIa,KAAK,CAAC,sBAAsBkB,KAAK,CAACC,OAAO,EAAE,CAAC;IACxD;EACF;EAEA;;;EAGAU,oBAAoBA,CAACC,MAAA;EAAA;EAAA,CAAAhD,aAAA,GAAAiB,CAAA,WAAiB,EAAE;IAAA;IAAAjB,aAAA,GAAAc,CAAA;IAAAd,aAAA,GAAAK,CAAA;IACtC,OAAOD,MAAM,CAACmB,WAAW,CAACyB,MAAM,CAAC,CAACb,QAAQ,CAAC,KAAK,CAAC;EACnD;EAEA;;;EAGAc,IAAIA,CAAC5B,IAAY;IAAA;IAAArB,aAAA,GAAAc,CAAA;IAAAd,aAAA,GAAAK,CAAA;IACf,OAAOD,MAAM,CAAC8C,UAAU,CAAC,QAAQ,CAAC,CAACpB,MAAM,CAACT,IAAI,CAAC,CAAC8B,MAAM,CAAC,KAAK,CAAC;EAC/D;EAEA;;;EAGAC,oBAAoBA,CAACb,aAAqB;IAAA;IAAAvC,aAAA,GAAAc,CAAA;IAAAd,aAAA,GAAAK,CAAA;IACxC,IAAI;MACF;MACA,MAAMgD,SAAS;MAAA;MAAA,CAAArD,aAAA,GAAAK,CAAA,QAAG,CAAC,IAAI,CAACK,QAAQ,GAAG,IAAI,CAACC,SAAS,IAAI,CAAC,GAAG,CAAC;MAAC;MAAAX,aAAA,GAAAK,CAAA;MAC3D,IAAIkC,aAAa,CAACS,MAAM,GAAGK,SAAS,EAAE;QAAA;QAAArD,aAAA,GAAAiB,CAAA;QAAAjB,aAAA,GAAAK,CAAA;QACpC,OAAO,KAAK;MACd,CAAC;MAAA;MAAA;QAAAL,aAAA,GAAAiB,CAAA;MAAA;MAED;MAAAjB,aAAA,GAAAK,CAAA;MACA,IAAI,CAACiC,OAAO,CAACC,aAAa,CAAC;MAAC;MAAAvC,aAAA,GAAAK,CAAA;MAC5B,OAAO,IAAI;IACb,CAAC,CAAC,MAAM;MAAA;MAAAL,aAAA,GAAAK,CAAA;MACN,OAAO,KAAK;IACd;EACF;CACD;AAAA;AAAAL,aAAA,GAAAK,CAAA;AAjGYC,aAAa,GAAAgD,UAAA,EADzBpD,UAAU,EAAE,E;;oCAQiCC,aAAa;AAAA;AAAA,CAAAH,aAAA,GAAAiB,CAAA,WAAbd,aAAa;AAAA;AAAA,CAAAH,aAAA,GAAAiB,CAAA,WAAAsC,EAAA;AAAA;AAAA,CAAAvD,aAAA,GAAAiB,CAAA,WAAAuC,MAAA,I,EAP9ClD,aAAa,CAiGzB","ignoreList":[]}