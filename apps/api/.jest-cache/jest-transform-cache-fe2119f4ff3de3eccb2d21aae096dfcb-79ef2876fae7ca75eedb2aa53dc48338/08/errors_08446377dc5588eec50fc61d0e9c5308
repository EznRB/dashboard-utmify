9ea91d3fe82fb29e3e5280e7a40de8de
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ExternalServiceError = exports.DatabaseError = exports.ValidationError = exports.ApiError = exports.ERROR_CODES = void 0;
exports.errorHandler = errorHandler;
exports.notFoundHandler = notFoundHandler;
exports.asyncHandler = asyncHandler;
const logger_1 = require("./logger");
// Custom error codes
exports.ERROR_CODES = {
    // Authentication errors
    INVALID_CREDENTIALS: 'INVALID_CREDENTIALS',
    INVALID_TOKEN: 'INVALID_TOKEN',
    INVALID_REFRESH_TOKEN: 'INVALID_REFRESH_TOKEN',
    MISSING_AUTH_HEADER: 'MISSING_AUTH_HEADER',
    MISSING_ACCESS_TOKEN: 'MISSING_ACCESS_TOKEN',
    SESSION_EXPIRED: 'SESSION_EXPIRED',
    AUTH_FAILED: 'AUTH_FAILED',
    AUTH_REQUIRED: 'AUTH_REQUIRED',
    // Authorization errors
    INSUFFICIENT_PERMISSIONS: 'INSUFFICIENT_PERMISSIONS',
    ORGANIZATION_REQUIRED: 'ORGANIZATION_REQUIRED',
    ORGANIZATION_DISABLED: 'ORGANIZATION_DISABLED',
    ACCOUNT_DISABLED: 'ACCOUNT_DISABLED',
    // Validation errors
    VALIDATION_ERROR: 'VALIDATION_ERROR',
    INVALID_INPUT: 'INVALID_INPUT',
    MISSING_REQUIRED_FIELD: 'MISSING_REQUIRED_FIELD',
    INVALID_EMAIL: 'INVALID_EMAIL',
    INVALID_PASSWORD: 'INVALID_PASSWORD',
    // Resource errors
    NOT_FOUND: 'NOT_FOUND',
    ALREADY_EXISTS: 'ALREADY_EXISTS',
    EMAIL_ALREADY_EXISTS: 'EMAIL_ALREADY_EXISTS',
    SLUG_ALREADY_EXISTS: 'SLUG_ALREADY_EXISTS',
    // Rate limiting
    RATE_LIMIT_EXCEEDED: 'RATE_LIMIT_EXCEEDED',
    TOO_MANY_REQUESTS: 'TOO_MANY_REQUESTS',
    // API errors
    MISSING_API_KEY: 'MISSING_API_KEY',
    INVALID_API_KEY: 'INVALID_API_KEY',
    // Webhook errors
    MISSING_WEBHOOK_SIGNATURE: 'MISSING_WEBHOOK_SIGNATURE',
    INVALID_WEBHOOK_SIGNATURE: 'INVALID_WEBHOOK_SIGNATURE',
    INVALID_WEBHOOK_TIMESTAMP: 'INVALID_WEBHOOK_TIMESTAMP',
    // Business logic errors
    PLAN_LIMIT_EXCEEDED: 'PLAN_LIMIT_EXCEEDED',
    FEATURE_NOT_AVAILABLE: 'FEATURE_NOT_AVAILABLE',
    QUOTA_EXCEEDED: 'QUOTA_EXCEEDED',
    // External service errors
    EXTERNAL_SERVICE_ERROR: 'EXTERNAL_SERVICE_ERROR',
    FACEBOOK_API_ERROR: 'FACEBOOK_API_ERROR',
    GOOGLE_API_ERROR: 'GOOGLE_API_ERROR',
    // File upload errors
    FILE_TOO_LARGE: 'FILE_TOO_LARGE',
    INVALID_FILE_TYPE: 'INVALID_FILE_TYPE',
    UPLOAD_FAILED: 'UPLOAD_FAILED',
    // Database errors
    DATABASE_ERROR: 'DATABASE_ERROR',
    TRANSACTION_FAILED: 'TRANSACTION_FAILED',
    // Generic errors
    INTERNAL_ERROR: 'INTERNAL_ERROR',
    SERVICE_UNAVAILABLE: 'SERVICE_UNAVAILABLE',
    LOGOUT_FAILED: 'LOGOUT_FAILED',
};
// Custom API Error class
class ApiError extends Error {
    code;
    statusCode;
    details;
    timestamp;
    constructor(message, code = exports.ERROR_CODES.INTERNAL_ERROR, statusCode = 500, details) {
        super(message);
        this.name = 'ApiError';
        this.code = code;
        this.statusCode = statusCode;
        this.details = details;
        this.timestamp = new Date().toISOString();
        // Maintain proper stack trace
        if (Error.captureStackTrace) {
            Error.captureStackTrace(this, ApiError);
        }
    }
    // Convert to JSON for API responses
    toJSON() {
        return {
            error: {
                message: this.message,
                code: this.code,
                statusCode: this.statusCode,
                timestamp: this.timestamp,
                ...(this.details && { details: this.details }),
            },
        };
    }
    // Static factory methods for common errors
    static badRequest(message, code, details) {
        return new ApiError(message, code || exports.ERROR_CODES.INVALID_INPUT, 400, details);
    }
    static unauthorized(message, code, details) {
        return new ApiError(message, code || exports.ERROR_CODES.AUTH_REQUIRED, 401, details);
    }
    static forbidden(message, code, details) {
        return new ApiError(message, code || exports.ERROR_CODES.INSUFFICIENT_PERMISSIONS, 403, details);
    }
    static notFound(message, code, details) {
        return new ApiError(message, code || exports.ERROR_CODES.NOT_FOUND, 404, details);
    }
    static conflict(message, code, details) {
        return new ApiError(message, code || exports.ERROR_CODES.ALREADY_EXISTS, 409, details);
    }
    static tooManyRequests(message, code, details) {
        return new ApiError(message, code || exports.ERROR_CODES.RATE_LIMIT_EXCEEDED, 429, details);
    }
    static internalError(message, code, details) {
        return new ApiError(message, code || exports.ERROR_CODES.INTERNAL_ERROR, 500, details);
    }
    static serviceUnavailable(message, code, details) {
        return new ApiError(message, code || exports.ERROR_CODES.SERVICE_UNAVAILABLE, 503, details);
    }
}
exports.ApiError = ApiError;
// Validation Error class
class ValidationError extends ApiError {
    constructor(message, details) {
        super(message, exports.ERROR_CODES.VALIDATION_ERROR, 400, details);
        this.name = 'ValidationError';
    }
    static fromZodError(error) {
        const details = error.errors?.map((err) => ({
            field: err.path.join('.'),
            message: err.message,
            code: err.code,
        }));
        return new ValidationError('Validation failed', details);
    }
}
exports.ValidationError = ValidationError;
// Database Error class
class DatabaseError extends ApiError {
    constructor(message, originalError, details) {
        super(message, exports.ERROR_CODES.DATABASE_ERROR, 500, details);
        this.name = 'DatabaseError';
        if (originalError) {
            this.stack = originalError.stack;
        }
    }
    static fromPrismaError(error) {
        let message = 'Database operation failed';
        let code = exports.ERROR_CODES.DATABASE_ERROR;
        let statusCode = 500;
        // Handle specific Prisma error codes
        switch (error.code) {
            case 'P2002':
                message = 'A record with this value already exists';
                code = exports.ERROR_CODES.ALREADY_EXISTS;
                statusCode = 409;
                break;
            case 'P2025':
                message = 'Record not found';
                code = exports.ERROR_CODES.NOT_FOUND;
                statusCode = 404;
                break;
            case 'P2003':
                message = 'Foreign key constraint failed';
                code = exports.ERROR_CODES.VALIDATION_ERROR;
                statusCode = 400;
                break;
            case 'P2014':
                message = 'Invalid ID provided';
                code = exports.ERROR_CODES.INVALID_INPUT;
                statusCode = 400;
                break;
            default:
                logger_1.logger.error(error, 'Unhandled Prisma error');
        }
        return new DatabaseError(message, error, {
            prismaCode: error.code,
            meta: error.meta,
        });
    }
}
exports.DatabaseError = DatabaseError;
// External Service Error class
class ExternalServiceError extends ApiError {
    service;
    constructor(service, message, originalError, details) {
        super(message, exports.ERROR_CODES.EXTERNAL_SERVICE_ERROR, 502, details);
        this.name = 'ExternalServiceError';
        this.service = service;
        if (originalError) {
            this.stack = originalError.stack;
        }
    }
    static facebook(message, error, details) {
        return new ExternalServiceError('Facebook', message, error, {
            ...details,
            code: exports.ERROR_CODES.FACEBOOK_API_ERROR,
        });
    }
    static google(message, error, details) {
        return new ExternalServiceError('Google', message, error, {
            ...details,
            code: exports.ERROR_CODES.GOOGLE_API_ERROR,
        });
    }
}
exports.ExternalServiceError = ExternalServiceError;
// Error handler for Fastify
function errorHandler(error, request, reply) {
    // Log error
    logger_1.logger.error({
        error: {
            message: error.message,
            stack: error.stack,
            code: error.code,
            statusCode: error.statusCode,
        },
        request: {
            method: request.method,
            url: request.url,
            headers: request.headers,
            ip: request.ip,
            userId: request.user?.id,
            organizationId: request.organization?.id,
        },
    }, 'Request error');
    // Handle different error types
    if (error instanceof ApiError) {
        return reply.status(error.statusCode).send(error.toJSON());
    }
    if (error instanceof ValidationError) {
        return reply.status(error.statusCode).send(error.toJSON());
    }
    if (error instanceof DatabaseError) {
        return reply.status(error.statusCode).send(error.toJSON());
    }
    if (error instanceof ExternalServiceError) {
        return reply.status(error.statusCode).send(error.toJSON());
    }
    // Handle Fastify validation errors
    if (error.validation) {
        const validationError = ValidationError.fromZodError(error);
        return reply.status(validationError.statusCode).send(validationError.toJSON());
    }
    // Handle rate limiting errors
    if (error.statusCode === 429) {
        const rateLimitError = ApiError.tooManyRequests('Too many requests, please try again later', exports.ERROR_CODES.RATE_LIMIT_EXCEEDED);
        return reply.status(429).send(rateLimitError.toJSON());
    }
    // Handle generic HTTP errors
    if (error.statusCode && error.statusCode < 500) {
        const apiError = new ApiError(error.message || 'Bad request', exports.ERROR_CODES.INVALID_INPUT, error.statusCode);
        return reply.status(error.statusCode).send(apiError.toJSON());
    }
    // Handle unexpected errors
    const internalError = ApiError.internalError('An unexpected error occurred', exports.ERROR_CODES.INTERNAL_ERROR, process.env.NODE_ENV === 'development' ? { originalError: error.message } : undefined);
    return reply.status(500).send(internalError.toJSON());
}
// Not found handler
function notFoundHandler(request, reply) {
    const notFoundError = ApiError.notFound(`Route ${request.method} ${request.url} not found`, exports.ERROR_CODES.NOT_FOUND);
    return reply.status(404).send(notFoundError.toJSON());
}
// Async error wrapper for route handlers
function asyncHandler(fn) {
    return (request, reply) => {
        return Promise.resolve(fn(request, reply)).catch((error) => {
            throw error;
        });
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxFbnpvIE1hcmNlbG9cXERlc2t0b3BcXFByb2pldG9zIEVtcHJlc2FcXFNhYXMgVXRtaWZ5XFx1dG1pZnktY2xvbmVcXGFwcHNcXGFwaVxcc3JjXFx1dGlsc1xcZXJyb3JzLnRzIiwibWFwcGluZ3MiOiI7OztBQW9QQSxvQ0FxRUM7QUFHRCwwQ0FPQztBQUdELG9DQU1DO0FBM1VELHFDQUFpQztBQUVqQyxxQkFBcUI7QUFDUixRQUFBLFdBQVcsR0FBRztJQUN6Qix3QkFBd0I7SUFDeEIsbUJBQW1CLEVBQUUscUJBQXFCO0lBQzFDLGFBQWEsRUFBRSxlQUFlO0lBQzlCLHFCQUFxQixFQUFFLHVCQUF1QjtJQUM5QyxtQkFBbUIsRUFBRSxxQkFBcUI7SUFDMUMsb0JBQW9CLEVBQUUsc0JBQXNCO0lBQzVDLGVBQWUsRUFBRSxpQkFBaUI7SUFDbEMsV0FBVyxFQUFFLGFBQWE7SUFDMUIsYUFBYSxFQUFFLGVBQWU7SUFFOUIsdUJBQXVCO0lBQ3ZCLHdCQUF3QixFQUFFLDBCQUEwQjtJQUNwRCxxQkFBcUIsRUFBRSx1QkFBdUI7SUFDOUMscUJBQXFCLEVBQUUsdUJBQXVCO0lBQzlDLGdCQUFnQixFQUFFLGtCQUFrQjtJQUVwQyxvQkFBb0I7SUFDcEIsZ0JBQWdCLEVBQUUsa0JBQWtCO0lBQ3BDLGFBQWEsRUFBRSxlQUFlO0lBQzlCLHNCQUFzQixFQUFFLHdCQUF3QjtJQUNoRCxhQUFhLEVBQUUsZUFBZTtJQUM5QixnQkFBZ0IsRUFBRSxrQkFBa0I7SUFFcEMsa0JBQWtCO0lBQ2xCLFNBQVMsRUFBRSxXQUFXO0lBQ3RCLGNBQWMsRUFBRSxnQkFBZ0I7SUFDaEMsb0JBQW9CLEVBQUUsc0JBQXNCO0lBQzVDLG1CQUFtQixFQUFFLHFCQUFxQjtJQUUxQyxnQkFBZ0I7SUFDaEIsbUJBQW1CLEVBQUUscUJBQXFCO0lBQzFDLGlCQUFpQixFQUFFLG1CQUFtQjtJQUV0QyxhQUFhO0lBQ2IsZUFBZSxFQUFFLGlCQUFpQjtJQUNsQyxlQUFlLEVBQUUsaUJBQWlCO0lBRWxDLGlCQUFpQjtJ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LE9BQU8sQ0FBQyxHQUFHLFlBQVksRUFDbEQsbUJBQVcsQ0FBQyxTQUFTLENBQ3RCLENBQUE7SUFFRCxPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFBO0FBQ3ZELENBQUM7QUFFRCx5Q0FBeUM7QUFDekMsU0FBZ0IsWUFBWSxDQUFDLEVBQVk7SUFDdkMsT0FBTyxDQUFDLE9BQVksRUFBRSxLQUFVLEVBQUUsRUFBRTtRQUNsQyxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO1lBQ3pELE1BQU0sS0FBSyxDQUFBO1FBQ2IsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDLENBQUE7QUFDSCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcRW56byBNYXJjZWxvXFxEZXNrdG9wXFxQcm9qZXRvcyBFbXByZXNhXFxTYWFzIFV0bWlmeVxcdXRtaWZ5LWNsb25lXFxhcHBzXFxhcGlcXHNyY1xcdXRpbHNcXGVycm9ycy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IEZhc3RpZnlFcnJvciB9IGZyb20gJ2Zhc3RpZnknXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuL2xvZ2dlcidcblxuLy8gQ3VzdG9tIGVycm9yIGNvZGVzXG5leHBvcnQgY29uc3QgRVJST1JfQ09ERVMgPSB7XG4gIC8vIEF1dGhlbnRpY2F0aW9uIGVycm9yc1xuICBJTlZBTElEX0NSRURFTlRJQUxTOiAnSU5WQUxJRF9DUkVERU5USUFMUycsXG4gIElOVkFMSURfVE9LRU46ICdJTlZBTElEX1RPS0VOJyxcbiAgSU5WQUxJRF9SRUZSRVNIX1RPS0VOOiAnSU5WQUxJRF9SRUZSRVNIX1RPS0VOJyxcbiAgTUlTU0lOR19BVVRIX0hFQURFUjogJ01JU1NJTkdfQVVUSF9IRUFERVInLFxuICBNSVNTSU5HX0FDQ0VTU19UT0tFTjogJ01JU1NJTkdfQUNDRVNTX1RPS0VOJyxcbiAgU0VTU0lPTl9FWFBJUkVEOiAnU0VTU0lPTl9FWFBJUkVEJyxcbiAgQVVUSF9GQUlMRUQ6ICdBVVRIX0ZBSUxFRCcsXG4gIEFVVEhfUkVRVUlSRUQ6ICdBVVRIX1JFUVVJUkVEJyxcbiAgXG4gIC8vIEF1dGhvcml6YXRpb24gZXJyb3JzXG4gIElOU1VGRklDSUVOVF9QRVJNSVNTSU9OUzogJ0lOU1VGRklDSUVOVF9QRVJNSVNTSU9OUycsXG4gIE9SR0FOSVpBVElPTl9SRVFVSVJFRDogJ09SR0FOSVpBVElPTl9SRVFVSVJFRCcsXG4gIE9SR0FOSVpBVElPTl9ESVNBQkxFRDogJ09SR0FOSVpBVElPTl9ESVNBQkxFRCcsXG4gIEFDQ09VTlRfRElTQUJMRUQ6ICdBQ0NPVU5UX0RJU0FCTEVEJyxcbiAgXG4gIC8vIFZhbGlkYXRpb24gZXJyb3JzXG4gIFZBTElEQVRJT05fRVJST1I6ICdWQUxJREFUSU9OX0VSUk9SJyxcbiAgSU5WQUxJRF9JTlBVVDogJ0lOVkFMSURfSU5QVVQnLFxuICBNSVNTSU5HX1JFUVVJUkVEX0ZJRUxEOiAnTUlTU0lOR19SRVFVSVJFRF9GSUVMRCcsXG4gIElOVkFMSURfRU1BSUw6ICdJTlZBTElEX0VNQUlMJyxcbiAgSU5WQUxJRF9QQVNTV09SRDogJ0lOVkFMSURfUEFTU1dPUkQnLFxuICBcbiAgLy8gUmVzb3VyY2UgZXJyb3JzXG4gIE5PVF9GT1VORDogJ05PVF9GT1VORCcsXG4gIEFMUkVBRFlfRVhJU1RTOiAnQUxSRUFEWV9FWElTVFMnLFxuICBFTUFJTF9BTFJFQURZX0VYSVNUUzogJ0VNQUlMX0FMUkVBRFlfRVhJU1RTJyxcbiAgU0xVR19BTFJFQURZX0VYSVNUUzogJ1NMVUdfQUxSRUFEWV9FWElTVFMnLFxuICBcbiAgLy8gUmF0ZSBsaW1pdGluZ1xuICBSQVRFX0xJTUlUX0VYQ0VFREVEOiAnUkFURV9MSU1JVF9FWENFRURFRCcsXG4gIFRPT19NQU5ZX1JFUVVFU1RTOiAnVE9PX01BTllfUkVRVUVTVFMnLFxuICBcbiAgLy8gQVBJIGVycm9yc1xuICBNSVNTSU5HX0FQSV9LRVk6ICdNSVNTSU5HX0FQSV9LRVknLFxuICBJTlZBTElEX0FQSV9LRVk6ICdJTlZBTElEX0FQSV9LRVknLFxuICBcbiAgLy8gV2ViaG9vayBlcnJvcnNcbiAgTUlTU0lOR19XRUJIT09LX1NJR05BVFVSRTogJ01JU1NJTkdfV0VCSE9PS19TSUdOQVRVUkUnLFxuICBJTlZBTElEX1dFQkhPT0tfU0lHTkFUVVJFOiAnSU5WQUxJRF9XRUJIT09LX1NJR05BVFVSRScsXG4gIElOVkFMSURfV0VCSE9PS19USU1FU1RBTVA6ICdJTlZBTElEX1dFQkhPT0tfVElNRVNUQU1QJyxcbiAgXG4gIC8vIEJ1c2luZXNzIGxvZ2ljIGVycm9yc1xuICBQTEFOX0xJTUlUX0VYQ0VFREVEOiAnUExBTl9MSU1JVF9FWENFRURFRCcsXG4gIEZFQVRVUkVfTk9UX0FWQUlMQUJMRTogJ0ZFQVRVUkVfTk9UX0FWQUlMQUJMRScsXG4gIFFVT1RBX0VYQ0VFREVEOiAnUVVPVEFfRVhDRUVERUQnLFxuICBcbiAgLy8gRXh0ZXJuYWwgc2VydmljZSBlcnJvcnNcbiAgRVhURVJOQUxfU0VSVklDRV9FUlJPUjogJ0VYVEVSTkFMX1NFUlZJQ0VfRVJST1InLFxuICBGQUNFQk9PS19BUElfRVJST1I6ICdGQUNFQk9PS19BUElfRVJST1InLFxuICBHT09HTEVfQVBJX0VSUk9SOiAnR09PR0xFX0FQSV9FUlJPUicsXG4gIFxuICAvLyBGaWxlIHVwbG9hZCBlcnJvcnNcbiAgRklMRV9UT09fTEFSR0U6ICdGSUxFX1RPT19MQVJHRScsXG4gIElOVkFMSURfRklMRV9UWVBFOiAnSU5WQUxJRF9GSUxFX1RZUEUnLFxuICBVUExPQURfRkFJTEVEOiAnVVBMT0FEX0ZBSUxFRCcsXG4gIFxuICAvLyBEYXRhYmFzZSBlcnJvcnNcbiAgREFUQUJBU0VfRVJST1I6ICdEQVRBQkFTRV9FUlJPUicsXG4gIFRSQU5TQUNUSU9OX0ZBSUxFRDogJ1RSQU5TQUNUSU9OX0ZBSUxFRCcsXG4gIFxuICAvLyBHZW5lcmljIGVycm9yc1xuICBJTlRFUk5BTF9FUlJPUjogJ0lOVEVSTkFMX0VSUk9SJyxcbiAgU0VSVklDRV9VTkFWQUlMQUJMRTogJ1NFUlZJQ0VfVU5BVkFJTEFCTEUnLFxuICBMT0dPVVRfRkFJTEVEOiAnTE9HT1VUX0ZBSUxFRCcsXG59IGFzIGNvbnN0XG5cbmV4cG9ydCB0eXBlIEVycm9yQ29kZSA9IGtleW9mIHR5cGVvZiBFUlJPUl9DT0RFU1xuXG4vLyBDdXN0b20gQVBJIEVycm9yIGNsYXNzXG5leHBvcnQgY2xhc3MgQXBpRXJyb3IgZXh0ZW5kcyBFcnJvciB7XG4gIHB1YmxpYyByZWFkb25seSBjb2RlOiBzdHJpbmdcbiAgcHVibGljIHJlYWRvbmx5IHN0YXR1c0NvZGU6IG51bWJlclxuICBwdWJsaWMgcmVhZG9ubHkgZGV0YWlscz86IGFueVxuICBwdWJsaWMgcmVhZG9ubHkgdGltZXN0YW1wOiBzdHJpbmdcblxuICBjb25zdHJ1Y3RvcihcbiAgICBtZXNzYWdlOiBzdHJpbmcsXG4gICAgY29kZTogc3RyaW5nID0gRVJST1JfQ09ERVMuSU5URVJOQUxfRVJST1IsXG4gICAgc3RhdHVzQ29kZTogbnVtYmVyID0gNTAwLFxuICAgIGRldGFpbHM/OiBhbnlcbiAgKSB7XG4gICAgc3VwZXIobWVzc2FnZSlcbiAgICB0aGlzLm5hbWUgPSAnQXBpRXJyb3InXG4gICAgdGhpcy5jb2RlID0gY29kZVxuICAgIHRoaXMuc3RhdHVzQ29kZSA9IHN0YXR1c0NvZGVcbiAgICB0aGlzLmRldGFpbHMgPSBkZXRhaWxzXG4gICAgdGhpcy50aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcblxuICAgIC8vIE1haW50YWluIHByb3BlciBzdGFjayB0cmFjZVxuICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkge1xuICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgQXBpRXJyb3IpXG4gICAgfVxuICB9XG5cbiAgLy8gQ29udmVydCB0byBKU09OIGZvciBBUEkgcmVzcG9uc2VzXG4gIHRvSlNPTigpIHtcbiAgICByZXR1cm4ge1xuICAgICAgZXJyb3I6IHtcbiAgICAgICAgbWVzc2FnZTogdGhpcy5tZXNzYWdlLFxuICAgICAgICBjb2RlOiB0aGlzLmNvZGUsXG4gICAgICAgIHN0YXR1c0NvZGU6IHRoaXMuc3RhdHVzQ29kZSxcbiAgICAgICAgdGltZXN0YW1wOiB0aGlzLnRpbWVzdGFtcCxcbiAgICAgICAgLi4uKHRoaXMuZGV0YWlscyAmJiB7IGRldGFpbHM6IHRoaXMuZGV0YWlscyB9KSxcbiAgICAgIH0sXG4gICAgfVxuICB9XG5cbiAgLy8gU3RhdGljIGZhY3RvcnkgbWV0aG9kcyBmb3IgY29tbW9uIGVycm9yc1xuICBzdGF0aWMgYmFkUmVxdWVzdChtZXNzYWdlOiBzdHJpbmcsIGNvZGU/OiBzdHJpbmcsIGRldGFpbHM/OiBhbnkpIHtcbiAgICByZXR1cm4gbmV3IEFwaUVycm9yKG1lc3NhZ2UsIGNvZGUgfHwgRVJST1JfQ09ERVMuSU5WQUxJRF9JTlBVVCwgNDAwLCBkZXRhaWxzKVxuICB9XG5cbiAgc3RhdGljIHVuYXV0aG9yaXplZChtZXNzYWdlOiBzdHJpbmcsIGNvZGU/OiBzdHJpbmcsIGRldGFpbHM/OiBhbnkpIHtcbiAgICByZXR1cm4gbmV3IEFwaUVycm9yKG1lc3NhZ2UsIGNvZGUgfHwgRVJST1JfQ09ERVMuQVVUSF9SRVFVSVJFRCwgNDAxLCBkZXRhaWxzKVxuICB9XG5cbiAgc3RhdGljIGZvcmJpZGRlbihtZXNzYWdlOiBzdHJpbmcsIGNvZGU/OiBzdHJpbmcsIGRldGFpbHM/OiBhbnkpIHtcbiAgICByZXR1cm4gbmV3IEFwaUVycm9yKG1lc3NhZ2UsIGNvZGUgfHwgRVJST1JfQ09ERVMuSU5TVUZGSUNJRU5UX1BFUk1JU1NJT05TLCA0MDMsIGRldGFpbHMpXG4gIH1cblxuICBzdGF0aWMgbm90Rm91bmQobWVzc2FnZTogc3RyaW5nLCBjb2RlPzogc3RyaW5nLCBkZXRhaWxzPzogYW55KSB7XG4gICAgcmV0dXJuIG5ldyBBcGlFcnJvcihtZXNzYWdlLCBjb2RlIHx8IEVSUk9SX0NPREVTLk5PVF9GT1VORCwgNDA0LCBkZXRhaWxzKVxuICB9XG5cbiAgc3RhdGljIGNvbmZsaWN0KG1lc3NhZ2U6IHN0cmluZywgY29kZT86IHN0cmluZywgZGV0YWlscz86IGFueSkge1xuICAgIHJldHVybiBuZXcgQXBpRXJyb3IobWVzc2FnZSwgY29kZSB8fCBFUlJPUl9DT0RFUy5BTFJFQURZX0VYSVNUUywgNDA5LCBkZXRhaWxzKVxuICB9XG5cbiAgc3RhdGljIHRvb01hbnlSZXF1ZXN0cyhtZXNzYWdlOiBzdHJpbmcsIGNvZGU/OiBzdHJpbmcsIGRldGFpbHM/OiBhbnkpIHtcbiAgICByZXR1cm4gbmV3IEFwaUVycm9yKG1lc3NhZ2UsIGNvZGUgfHwgRVJST1JfQ09ERVMuUkFURV9MSU1JVF9FWENFRURFRCwgNDI5LCBkZXRhaWxzKVxuICB9XG5cbiAgc3RhdGljIGludGVybmFsRXJyb3IobWVzc2FnZTogc3RyaW5nLCBjb2RlPzogc3RyaW5nLCBkZXRhaWxzPzogYW55KSB7XG4gICAgcmV0dXJuIG5ldyBBcGlFcnJvcihtZXNzYWdlLCBjb2RlIHx8IEVSUk9SX0NPREVTLklOVEVSTkFMX0VSUk9SLCA1MDAsIGRldGFpbHMpXG4gIH1cblxuICBzdGF0aWMgc2VydmljZVVuYXZhaWxhYmxlKG1lc3NhZ2U6IHN0cmluZywgY29kZT86IHN0cmluZywgZGV0YWlscz86IGFueSkge1xuICAgIHJldHVybiBuZXcgQXBpRXJyb3IobWVzc2FnZSwgY29kZSB8fCBFUlJPUl9DT0RFUy5TRVJWSUNFX1VOQVZBSUxBQkxFLCA1MDMsIGRldGFpbHMpXG4gIH1cbn1cblxuLy8gVmFsaWRhdGlvbiBFcnJvciBjbGFzc1xuZXhwb3J0IGNsYXNzIFZhbGlkYXRpb25FcnJvciBleHRlbmRzIEFwaUVycm9yIHtcbiAgY29uc3RydWN0b3IobWVzc2FnZTogc3RyaW5nLCBkZXRhaWxzPzogYW55KSB7XG4gICAgc3VwZXIobWVzc2FnZSwgRVJST1JfQ09ERVMuVkFMSURBVElPTl9FUlJPUiwgNDAwLCBkZXRhaWxzKVxuICAgIHRoaXMubmFtZSA9ICdWYWxpZGF0aW9uRXJyb3InXG4gIH1cblxuICBzdGF0aWMgZnJvbVpvZEVycm9yKGVycm9yOiBhbnkpIHtcbiAgICBjb25zdCBkZXRhaWxzID0gZXJyb3IuZXJyb3JzPy5tYXAoKGVycjogYW55KSA9PiAoe1xuICAgICAgZmllbGQ6IGVyci5wYXRoLmpvaW4oJy4nKSxcbiAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuICAgICAgY29kZTogZXJyLmNvZGUsXG4gICAgfSkpXG5cbiAgICByZXR1cm4gbmV3IFZhbGlkYXRpb25FcnJvcignVmFsaWRhdGlvbiBmYWlsZWQnLCBkZXRhaWxzKVxuICB9XG59XG5cbi8vIERhdGFiYXNlIEVycm9yIGNsYXNzXG5leHBvcnQgY2xhc3MgRGF0YWJhc2VFcnJvciBleHRlbmRzIEFwaUVycm9yIHtcbiAgY29uc3RydWN0b3IobWVzc2FnZTogc3RyaW5nLCBvcmlnaW5hbEVycm9yPzogRXJyb3IsIGRldGFpbHM/OiBhbnkpIHtcbiAgICBzdXBlcihtZXNzYWdlLCBFUlJPUl9DT0RFUy5EQVRBQkFTRV9FUlJPUiwgNTAwLCBkZXRhaWxzKVxuICAgIHRoaXMubmFtZSA9ICdEYXRhYmFzZUVycm9yJ1xuICAgIFxuICAgIGlmIChvcmlnaW5hbEVycm9yKSB7XG4gICAgICB0aGlzLnN0YWNrID0gb3JpZ2luYWxFcnJvci5zdGFja1xuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBmcm9tUHJpc21hRXJyb3IoZXJyb3I6IGFueSkge1xuICAgIGxldCBtZXNzYWdlID0gJ0RhdGFiYXNlIG9wZXJhdGlvbiBmYWlsZWQnXG4gICAgbGV0IGNvZGUgPSBFUlJPUl9DT0RFUy5EQVRBQkFTRV9FUlJPUlxuICAgIGxldCBzdGF0dXNDb2RlID0gNTAwXG5cbiAgICAvLyBIYW5kbGUgc3BlY2lmaWMgUHJpc21hIGVycm9yIGNvZGVzXG4gICAgc3dpdGNoIChlcnJvci5jb2RlKSB7XG4gICAgICBjYXNlICdQMjAwMic6XG4gICAgICAgIG1lc3NhZ2UgPSAnQSByZWNvcmQgd2l0aCB0aGlzIHZhbHVlIGFscmVhZHkgZXhpc3RzJ1xuICAgICAgICBjb2RlID0gRVJST1JfQ09ERVMuQUxSRUFEWV9FWElTVFNcbiAgICAgICAgc3RhdHVzQ29kZSA9IDQwOVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAnUDIwMjUnOlxuICAgICAgICBtZXNzYWdlID0gJ1JlY29yZCBub3QgZm91bmQnXG4gICAgICAgIGNvZGUgPSBFUlJPUl9DT0RFUy5OT1RfRk9VTkRcbiAgICAgICAgc3RhdHVzQ29kZSA9IDQwNFxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAnUDIwMDMnOlxuICAgICAgICBtZXNzYWdlID0gJ0ZvcmVpZ24ga2V5IGNvbnN0cmFpbnQgZmFpbGVkJ1xuICAgICAgICBjb2RlID0gRVJST1JfQ09ERVMuVkFMSURBVElPTl9FUlJPUlxuICAgICAgICBzdGF0dXNDb2RlID0gNDAwXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlICdQMjAxNCc6XG4gICAgICAgIG1lc3NhZ2UgPSAnSW52YWxpZCBJRCBwcm92aWRlZCdcbiAgICAgICAgY29kZSA9IEVSUk9SX0NPREVTLklOVkFMSURfSU5QVVRcbiAgICAgICAgc3RhdHVzQ29kZSA9IDQwMFxuICAgICAgICBicmVha1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgbG9nZ2VyLmVycm9yKGVycm9yLCAnVW5oYW5kbGVkIFByaXNtYSBlcnJvcicpXG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBEYXRhYmFzZUVycm9yKG1lc3NhZ2UsIGVycm9yLCB7XG4gICAgICBwcmlzbWFDb2RlOiBlcnJvci5jb2RlLFxuICAgICAgbWV0YTogZXJyb3IubWV0YSxcbiAgICB9KVxuICB9XG59XG5cbi8vIEV4dGVybmFsIFNlcnZpY2UgRXJyb3IgY2xhc3NcbmV4cG9ydCBjbGFzcyBFeHRlcm5hbFNlcnZpY2VFcnJvciBleHRlbmRzIEFwaUVycm9yIHtcbiAgcHVibGljIHJlYWRvbmx5IHNlcnZpY2U6IHN0cmluZ1xuXG4gIGNvbnN0cnVjdG9yKHNlcnZpY2U6IHN0cmluZywgbWVzc2FnZTogc3RyaW5nLCBvcmlnaW5hbEVycm9yPzogRXJyb3IsIGRldGFpbHM/OiBhbnkpIHtcbiAgICBzdXBlcihtZXNzYWdlLCBFUlJPUl9DT0RFUy5FWFRFUk5BTF9TRVJWSUNFX0VSUk9SLCA1MDIsIGRldGFpbHMpXG4gICAgdGhpcy5uYW1lID0gJ0V4dGVybmFsU2VydmljZUVycm9yJ1xuICAgIHRoaXMuc2VydmljZSA9IHNlcnZpY2VcbiAgICBcbiAgICBpZiAob3JpZ2luYWxFcnJvcikge1xuICAgICAgdGhpcy5zdGFjayA9IG9yaWdpbmFsRXJyb3Iuc3RhY2tcbiAgICB9XG4gIH1cblxuICBzdGF0aWMgZmFjZWJvb2sobWVzc2FnZTogc3RyaW5nLCBlcnJvcj86IEVycm9yLCBkZXRhaWxzPzogYW55KSB7XG4gICAgcmV0dXJuIG5ldyBFeHRlcm5hbFNlcnZpY2VFcnJvcignRmFjZWJvb2snLCBtZXNzYWdlLCBlcnJvciwge1xuICAgICAgLi4uZGV0YWlscyxcbiAgICAgIGNvZGU6IEVSUk9SX0NPREVTLkZBQ0VCT09LX0FQSV9FUlJPUixcbiAgICB9KVxuICB9XG5cbiAgc3RhdGljIGdvb2dsZShtZXNzYWdlOiBzdHJpbmcsIGVycm9yPzogRXJyb3IsIGRldGFpbHM/OiBhbnkpIHtcbiAgICByZXR1cm4gbmV3IEV4dGVybmFsU2VydmljZUVycm9yKCdHb29nbGUnLCBtZXNzYWdlLCBlcnJvciwge1xuICAgICAgLi4uZGV0YWlscyxcbiAgICAgIGNvZGU6IEVSUk9SX0NPREVTLkdPT0dMRV9BUElfRVJST1IsXG4gICAgfSlcbiAgfVxufVxuXG4vLyBFcnJvciBoYW5kbGVyIGZvciBGYXN0aWZ5XG5leHBvcnQgZnVuY3Rpb24gZXJyb3JIYW5kbGVyKGVycm9yOiBGYXN0aWZ5RXJyb3IsIHJlcXVlc3Q6IGFueSwgcmVwbHk6IGFueSkge1xuICAvLyBMb2cgZXJyb3JcbiAgbG9nZ2VyLmVycm9yKHtcbiAgICBlcnJvcjoge1xuICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcbiAgICAgIHN0YWNrOiBlcnJvci5zdGFjayxcbiAgICAgIGNvZGU6IChlcnJvciBhcyBhbnkpLmNvZGUsXG4gICAgICBzdGF0dXNDb2RlOiBlcnJvci5zdGF0dXNDb2RlLFxuICAgIH0sXG4gICAgcmVxdWVzdDoge1xuICAgICAgbWV0aG9kOiByZXF1ZXN0Lm1ldGhvZCxcbiAgICAgIHVybDogcmVxdWVzdC51cmwsXG4gICAgICBoZWFkZXJzOiByZXF1ZXN0LmhlYWRlcnMsXG4gICAgICBpcDogcmVxdWVzdC5pcCxcbiAgICAgIHVzZXJJZDogcmVxdWVzdC51c2VyPy5pZCxcbiAgICAgIG9yZ2FuaXphdGlvbklkOiByZXF1ZXN0Lm9yZ2FuaXphdGlvbj8uaWQsXG4gICAgfSxcbiAgfSwgJ1JlcXVlc3QgZXJyb3InKVxuXG4gIC8vIEhhbmRsZSBkaWZmZXJlbnQgZXJyb3IgdHlwZXNcbiAgaWYgKGVycm9yIGluc3RhbmNlb2YgQXBpRXJyb3IpIHtcbiAgICByZXR1cm4gcmVwbHkuc3RhdHVzKGVycm9yLnN0YXR1c0NvZGUpLnNlbmQoZXJyb3IudG9KU09OKCkpXG4gIH1cblxuICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBWYWxpZGF0aW9uRXJyb3IpIHtcbiAgICByZXR1cm4gcmVwbHkuc3RhdHVzKGVycm9yLnN0YXR1c0NvZGUpLnNlbmQoZXJyb3IudG9KU09OKCkpXG4gIH1cblxuICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBEYXRhYmFzZUVycm9yKSB7XG4gICAgcmV0dXJuIHJlcGx5LnN0YXR1cyhlcnJvci5zdGF0dXNDb2RlKS5zZW5kKGVycm9yLnRvSlNPTigpKVxuICB9XG5cbiAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXh0ZXJuYWxTZXJ2aWNlRXJyb3IpIHtcbiAgICByZXR1cm4gcmVwbHkuc3RhdHVzKGVycm9yLnN0YXR1c0NvZGUpLnNlbmQoZXJyb3IudG9KU09OKCkpXG4gIH1cblxuICAvLyBIYW5kbGUgRmFzdGlmeSB2YWxpZGF0aW9uIGVycm9yc1xuICBpZiAoZXJyb3IudmFsaWRhdGlvbikge1xuICAgIGNvbnN0IHZhbGlkYXRpb25FcnJvciA9IFZhbGlkYXRpb25FcnJvci5mcm9tWm9kRXJyb3IoZXJyb3IpXG4gICAgcmV0dXJuIHJlcGx5LnN0YXR1cyh2YWxpZGF0aW9uRXJyb3Iuc3RhdHVzQ29kZSkuc2VuZCh2YWxpZGF0aW9uRXJyb3IudG9KU09OKCkpXG4gIH1cblxuICAvLyBIYW5kbGUgcmF0ZSBsaW1pdGluZyBlcnJvcnNcbiAgaWYgKGVycm9yLnN0YXR1c0NvZGUgPT09IDQyOSkge1xuICAgIGNvbnN0IHJhdGVMaW1pdEVycm9yID0gQXBpRXJyb3IudG9vTWFueVJlcXVlc3RzKFxuICAgICAgJ1RvbyBtYW55IHJlcXVlc3RzLCBwbGVhc2UgdHJ5IGFnYWluIGxhdGVyJyxcbiAgICAgIEVSUk9SX0NPREVTLlJBVEVfTElNSVRfRVhDRUVERURcbiAgICApXG4gICAgcmV0dXJuIHJlcGx5LnN0YXR1cyg0MjkpLnNlbmQocmF0ZUxpbWl0RXJyb3IudG9KU09OKCkpXG4gIH1cblxuICAvLyBIYW5kbGUgZ2VuZXJpYyBIVFRQIGVycm9yc1xuICBpZiAoZXJyb3Iuc3RhdHVzQ29kZSAmJiBlcnJvci5zdGF0dXNDb2RlIDwgNTAwKSB7XG4gICAgY29uc3QgYXBpRXJyb3IgPSBuZXcgQXBpRXJyb3IoXG4gICAgICBlcnJvci5tZXNzYWdlIHx8ICdCYWQgcmVxdWVzdCcsXG4gICAgICBFUlJPUl9DT0RFUy5JTlZBTElEX0lOUFVULFxuICAgICAgZXJyb3Iuc3RhdHVzQ29kZVxuICAgIClcbiAgICByZXR1cm4gcmVwbHkuc3RhdHVzKGVycm9yLnN0YXR1c0NvZGUpLnNlbmQoYXBpRXJyb3IudG9KU09OKCkpXG4gIH1cblxuICAvLyBIYW5kbGUgdW5leHBlY3RlZCBlcnJvcnNcbiAgY29uc3QgaW50ZXJuYWxFcnJvciA9IEFwaUVycm9yLmludGVybmFsRXJyb3IoXG4gICAgJ0FuIHVuZXhwZWN0ZWQgZXJyb3Igb2NjdXJyZWQnLFxuICAgIEVSUk9SX0NPREVTLklOVEVSTkFMX0VSUk9SLFxuICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnID8geyBvcmlnaW5hbEVycm9yOiBlcnJvci5tZXNzYWdlIH0gOiB1bmRlZmluZWRcbiAgKVxuXG4gIHJldHVybiByZXBseS5zdGF0dXMoNTAwKS5zZW5kKGludGVybmFsRXJyb3IudG9KU09OKCkpXG59XG5cbi8vIE5vdCBmb3VuZCBoYW5kbGVyXG5leHBvcnQgZnVuY3Rpb24gbm90Rm91bmRIYW5kbGVyKHJlcXVlc3Q6IGFueSwgcmVwbHk6IGFueSkge1xuICBjb25zdCBub3RGb3VuZEVycm9yID0gQXBpRXJyb3Iubm90Rm91bmQoXG4gICAgYFJvdXRlICR7cmVxdWVzdC5tZXRob2R9ICR7cmVxdWVzdC51cmx9IG5vdCBmb3VuZGAsXG4gICAgRVJST1JfQ09ERVMuTk9UX0ZPVU5EXG4gIClcblxuICByZXR1cm4gcmVwbHkuc3RhdHVzKDQwNCkuc2VuZChub3RGb3VuZEVycm9yLnRvSlNPTigpKVxufVxuXG4vLyBBc3luYyBlcnJvciB3cmFwcGVyIGZvciByb3V0ZSBoYW5kbGVyc1xuZXhwb3J0IGZ1bmN0aW9uIGFzeW5jSGFuZGxlcihmbjogRnVuY3Rpb24pIHtcbiAgcmV0dXJuIChyZXF1ZXN0OiBhbnksIHJlcGx5OiBhbnkpID0+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZuKHJlcXVlc3QsIHJlcGx5KSkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICB0aHJvdyBlcnJvclxuICAgIH0pXG4gIH1cbn0iXSwidmVyc2lvbiI6M30=